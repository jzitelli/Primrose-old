// Tue, 09 Jun 2015 13:36:16 GMT

/*
 * Copyright (c) 2015 cannon.js Authors
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&false)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.CANNON=e()}}(function(){return function e(f,n,o){function d(t,l){if(!n[t]){if(!f[t]){var u="function"==typeof require&&require;if(!l&&u)return u(t,!0);if(i)return i(t,!0);throw new Error("Cannot find module '"+t+"'")}var p=n[t]={exports:{}};f[t][0].call(p.exports,function(e){var n=f[t][1][e];return d(n?n:e)},p,p.exports,e,f,n,o)}return n[t].exports}for(var i="function"==typeof require&&require,t=0;t<o.length;t++)d(o[t]);return d}({1:[function(e,f,n){f.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./src/Cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,f,n){f.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,f,n){function o(e){e=e||{},this.lowerBound=new d,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new d,e.upperBound&&this.upperBound.copy(e.upperBound)}var d=e("../math/Vec3");e("../utils/Utils");f.exports=o;var i=new d;o.prototype.setFromPoints=function(e,f,n,o){var d=this.lowerBound,t=this.upperBound,l=n;d.copy(e[0]),l&&l.vmult(d,d),t.copy(d);for(var u=1;u<e.length;u++){var p=e[u];l&&(l.vmult(p,i),p=i),p.x>t.x&&(t.x=p.x),p.x<d.x&&(d.x=p.x),p.y>t.y&&(t.y=p.y),p.y<d.y&&(d.y=p.y),p.z>t.z&&(t.z=p.z),p.z<d.z&&(d.z=p.z)}return f&&(f.vadd(d,d),f.vadd(t,t)),o&&(d.x-=o,d.y-=o,d.z-=o,t.x+=o,t.y+=o,t.z+=o),this},o.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},o.prototype.clone=function(){return(new o).copy(this)},o.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},o.prototype.overlaps=function(e){var f=this.lowerBound,n=this.upperBound,o=e.lowerBound,d=e.upperBound,i=o.x<=n.x&&n.x<=d.x||f.x<=d.x&&d.x<=n.x,t=o.y<=n.y&&n.y<=d.y||f.y<=d.y&&d.y<=n.y,l=o.z<=n.z&&n.z<=d.z||f.z<=d.z&&d.z<=n.z;return i&&t&&l},o.prototype.volume=function(){var e=this.lowerBound,f=this.upperBound;return(f.x-e.x)*(f.y-e.y)*(f.z-e.z)},o.prototype.contains=function(e){var f=this.lowerBound,n=this.upperBound,o=e.lowerBound,d=e.upperBound;return f.x<=o.x&&n.x>=d.x&&f.y<=o.y&&n.y>=d.y&&f.z<=o.z&&n.z>=d.z},o.prototype.getCorners=function(e,f,n,o,d,i,t,l){var u=this.lowerBound,p=this.upperBound;e.copy(u),f.set(p.x,u.y,u.z),n.set(p.x,p.y,u.z),o.set(u.x,p.y,p.z),d.set(p.x,u.y,u.z),i.set(u.x,p.y,u.z),t.set(u.x,u.y,p.z),l.copy(p)};var t=[new d,new d,new d,new d,new d,new d,new d,new d];o.prototype.toLocalFrame=function(e,f){var n=t,o=n[0],d=n[1],i=n[2],l=n[3],u=n[4],p=n[5],s=n[6],y=n[7];this.getCorners(o,d,i,l,u,p,s,y);for(var c=0;8!==c;c++){var a=n[c];e.pointToLocal(a,a)}return f.setFromPoints(n)},o.prototype.toWorldFrame=function(e,f){var n=t,o=n[0],d=n[1],i=n[2],l=n[3],u=n[4],p=n[5],s=n[6],y=n[7];this.getCorners(o,d,i,l,u,p,s,y);for(var c=0;8!==c;c++){var a=n[c];e.pointToWorld(a,a)}return f.setFromPoints(n)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,f,n){function o(){this.matrix=[]}f.exports=o,o.prototype.get=function(e,f){if(e=e.index,f=f.index,f>e){var n=f;f=e,e=n}return this.matrix[(e*(e+1)>>1)+f-1]},o.prototype.set=function(e,f,n){if(e=e.index,f=f.index,f>e){var o=f;f=e,e=o}this.matrix[(e*(e+1)>>1)+f-1]=n?1:0},o.prototype.reset=function(){for(var e=0,f=this.matrix.length;e!==f;e++)this.matrix[e]=0},o.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,f,n){function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}var d=e("../objects/Body"),i=e("../math/Vec3"),t=e("../math/Quaternion");e("../shapes/Shape"),e("../shapes/Plane");f.exports=o,o.prototype.collisionPairs=function(e,f,n){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var l=d.STATIC|d.KINEMATIC;o.prototype.needBroadphaseCollision=function(e,f){return 0===(e.collisionFilterGroup&f.collisionFilterMask)||0===(f.collisionFilterGroup&e.collisionFilterMask)?!1:0===(e.type&l)&&e.sleepState!==d.SLEEPING||0===(f.type&l)&&f.sleepState!==d.SLEEPING?!0:!1},o.prototype.intersectionTest=function(e,f,n,o){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,f,n,o):this.doBoundingSphereBroadphase(e,f,n,o)};var u=new i;new i,new t,new i;o.prototype.doBoundingSphereBroadphase=function(e,f,n,o){var d=u;f.position.vsub(e.position,d);var i=Math.pow(e.boundingRadius+f.boundingRadius,2),t=d.norm2();i>t&&(n.push(e),o.push(f))},o.prototype.doBoundingBoxBroadphase=function(e,f,n,o){e.aabbNeedsUpdate&&e.computeAABB(),f.aabbNeedsUpdate&&f.computeAABB(),e.aabb.overlaps(f.aabb)&&(n.push(e),o.push(f))};var p={keys:[]},s=[],y=[];o.prototype.makePairsUnique=function(e,f){for(var n=p,o=s,d=y,i=e.length,t=0;t!==i;t++)o[t]=e[t],d[t]=f[t];e.length=0,f.length=0;for(var t=0;t!==i;t++){var l=o[t].id,u=d[t].id,c=u>l?l+","+u:u+","+l;n[c]=t,n.keys.push(c)}for(var t=0;t!==n.keys.length;t++){var c=n.keys.pop(),a=n[c];e.push(o[a]),f.push(d[a]),delete n[c]}},o.prototype.setWorld=function(e){};var c=new i;o.boundingSphereCheck=function(e,f){var n=c;return e.position.vsub(f.position,n),Math.pow(e.shape.boundingSphereRadius+f.shape.boundingSphereRadius,2)>n.norm2()},o.prototype.aabbQuery=function(e,f,n){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,f,n){function o(e,f,n,o,t){d.apply(this),this.nx=n||10,this.ny=o||10,this.nz=t||10,this.aabbMin=e||new i(100,100,100),this.aabbMax=f||new i(-100,-100,-100);var l=this.nx*this.ny*this.nz;if(0>=l)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=l,this.binLengths.length=l;for(var u=0;l>u;u++)this.bins[u]=[],this.binLengths[u]=0}f.exports=o;var d=e("./Broadphase"),i=e("../math/Vec3"),t=e("../shapes/Shape");o.prototype=new d,o.prototype.constructor=o;var l=new i;new i;o.prototype.collisionPairs=function(e,f,n){function o(e,f,n,o,d,i,t){var l=(e-g)*v|0,u=(f-x)*A|0,p=(n-j)*C|0,b=I((o-g)*v),m=I((d-x)*A),N=I((i-j)*C);0>l?l=0:l>=s&&(l=s-1),0>u?u=0:u>=y&&(u=y-1),0>p?p=0:p>=c&&(p=c-1),0>b?b=0:b>=s&&(b=s-1),0>m?m=0:m>=y&&(m=y-1),0>N?N=0:N>=c&&(N=c-1),l*=a,u*=r,p*=w,b*=a,m*=r,N*=w;for(var O=l;b>=O;O+=a)for(var h=u;m>=h;h+=r)for(var k=p;N>=k;k+=w){var q=O+h+k;E[q][F[q]++]=t}}for(var d=e.numObjects(),i=e.bodies,u=this.aabbMax,p=this.aabbMin,s=this.nx,y=this.ny,c=this.nz,a=y*c,r=c,w=1,b=u.x,m=u.y,N=u.z,g=p.x,x=p.y,j=p.z,v=s/(b-g),A=y/(m-x),C=c/(N-j),O=(b-g)/s,h=(m-x)/y,k=(N-j)/c,q=.5*Math.sqrt(O*O+h*h+k*k),z=t.types,B=z.SPHERE,D=z.PLANE,E=(z.BOX,z.COMPOUND,z.CONVEXPOLYHEDRON,this.bins),F=this.binLengths,G=this.bins.length,H=0;H!==G;H++)F[H]=0;for(var I=Math.ceil,p=Math.min,u=Math.max,H=0;H!==d;H++){var J=i[H],K=J.shape;switch(K.type){case B:var L=J.position.x,M=J.position.y,P=J.position.z,Q=K.radius;o(L-Q,M-Q,P-Q,L+Q,M+Q,P+Q,J);break;case D:K.worldNormalNeedsUpdate&&K.computeWorldNormal(J.quaternion);var R=K.worldNormal,S=g+.5*O-J.position.x,T=x+.5*h-J.position.y,U=j+.5*k-J.position.z,V=l;V.set(S,T,U);for(var W=0,X=0;W!==s;W++,X+=a,V.y=T,V.x+=O)for(var Y=0,Z=0;Y!==y;Y++,Z+=r,V.z=U,V.y+=h)for(var $=0,_=0;$!==c;$++,_+=w,V.z+=k)if(V.dot(R)<q){var ee=X+Z+_;E[ee][F[ee]++]=J}break;default:J.aabbNeedsUpdate&&J.computeAABB(),o(J.aabb.lowerBound.x,J.aabb.lowerBound.y,J.aabb.lowerBound.z,J.aabb.upperBound.x,J.aabb.upperBound.y,J.aabb.upperBound.z,J)}}for(var H=0;H!==G;H++){var fe=F[H];if(fe>1)for(var ne=E[H],W=0;W!==fe;W++)for(var J=ne[W],Y=0;Y!==W;Y++){var oe=ne[Y];this.needBroadphaseCollision(J,oe)&&this.intersectionTest(J,oe,f,n)}}this.makePairsUnique(f,n)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,f,n){function o(){d.apply(this)}f.exports=o;var d=e("./Broadphase"),i=e("./AABB");o.prototype=new d,o.prototype.constructor=o,o.prototype.collisionPairs=function(e,f,n){var o,d,i,t,l=e.bodies,u=l.length;for(o=0;o!==u;o++)for(d=0;d!==o;d++)i=l[o],t=l[d],this.needBroadphaseCollision(i,t)&&this.intersectionTest(i,t,f,n)};new i;o.prototype.aabbQuery=function(e,f,n){n=n||[];for(var o=0;o<e.bodies.length;o++){var d=e.bodies[o];d.aabbNeedsUpdate&&d.computeAABB(),d.aabb.overlaps(f)&&n.push(d)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(e,f,n){function o(){this.matrix={}}f.exports=o,o.prototype.get=function(e,f){if(e=e.id,f=f.id,f>e){var n=f;f=e,e=n}return e+"-"+f in this.matrix},o.prototype.set=function(e,f,n){if(e=e.id,f=f.id,f>e){var o=f;f=e,e=o}n?this.matrix[e+"-"+f]=!0:delete this.matrix[e+"-"+f]},o.prototype.reset=function(){this.matrix={}},o.prototype.setNumObjects=function(e){}},{}],9:[function(e,f,n){function o(e,f){this.from=e?e.clone():new t,this.to=f?f.clone():new t,this._direction=new t,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=o.ANY,this.result=new p,this.hasHit=!1,this.callback=function(e){}}function d(e,f,n,o){o.vsub(f,H),n.vsub(f,r),e.vsub(f,w);var d,i,t=H.dot(H),l=H.dot(r),u=H.dot(w),p=r.dot(r),s=r.dot(w);return(d=p*u-l*s)>=0&&(i=t*s-l*u)>=0&&t*p-l*l>d+i}function i(e,f,n){n.vsub(e,H);var o=H.dot(f);f.mult(o,I),I.vadd(e,I);var d=n.distanceTo(I);return d}f.exports=o;var t=e("../math/Vec3"),l=e("../math/Quaternion"),u=e("../math/Transform"),p=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),s=e("../shapes/Shape"),y=e("../collision/AABB");o.prototype.constructor=o,o.CLOSEST=1,o.ANY=2,o.ALL=4;var c=new y,a=[];o.prototype.intersectWorld=function(e,f){return this.mode=f.mode||o.ANY,this.result=f.result||new p,this.skipBackfaces=!!f.skipBackfaces,this.collisionFilterMask="undefined"!=typeof f.collisionFilterMask?f.collisionFilterMask:-1,this.collisionFilterGroup="undefined"!=typeof f.collisionFilterGroup?f.collisionFilterGroup:-1,f.from&&this.from.copy(f.from),f.to&&this.to.copy(f.to),this.callback=f.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(c),a.length=0,e.broadphase.aabbQuery(e,c,a),this.intersectBodies(a),this.hasHit};var r=new t,w=new t;o.pointInTriangle=d;var b=new t,m=new l;o.prototype.intersectBody=function(e,f){f&&(this.result=f,this._updateDirection());var n=this.checkCollisionResponse;if((!n||e.collisionResponse)&&0!==(this.collisionFilterGroup&e.collisionFilterMask)&&0!==(e.collisionFilterGroup&this.collisionFilterMask))for(var o=b,d=m,i=0,t=e.shapes.length;t>i;i++){var l=e.shapes[i];if((!n||l.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[i],d),e.quaternion.vmult(e.shapeOffsets[i],o),o.vadd(e.position,o),this.intersectShape(l,d,o,e),this.result._shouldStop))break}},o.prototype.intersectBodies=function(e,f){f&&(this.result=f,this._updateDirection());for(var n=0,o=e.length;!this.result._shouldStop&&o>n;n++)this.intersectBody(e[n])},o.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},o.prototype.intersectShape=function(e,f,n,o){var d=this.from,t=i(d,this._direction,n);if(!(t>e.boundingSphereRadius)){var l=this[e.type];l&&l.call(this,e,f,n,o,e)}};var N=(new t,new t,new t),g=new t,x=new t,j=new t;new t,new p;o.prototype.intersectBox=function(e,f,n,o,d){return this.intersectConvex(e.convexPolyhedronRepresentation,f,n,o,d)},o.prototype[s.types.BOX]=o.prototype.intersectBox,o.prototype.intersectPlane=function(e,f,n,o,d){var i=this.from,l=this.to,u=this._direction,p=new t(0,0,1);f.vmult(p,p);var s=new t;i.vsub(n,s);var y=s.dot(p);l.vsub(n,s);var c=s.dot(p);if(!(y*c>0||i.distanceTo(l)<y)){var a=p.dot(u);if(!(Math.abs(a)<this.precision)){var r=new t,w=new t,b=new t;i.vsub(n,r);var m=-p.dot(r)/a;u.scale(m,w),i.vadd(w,b),this.reportIntersection(p,b,d,o,-1)}}},o.prototype[s.types.PLANE]=o.prototype.intersectPlane,o.prototype.getAABB=function(e){var f=this.to,n=this.from;e.lowerBound.x=Math.min(f.x,n.x),e.lowerBound.y=Math.min(f.y,n.y),e.lowerBound.z=Math.min(f.z,n.z),e.upperBound.x=Math.max(f.x,n.x),e.upperBound.y=Math.max(f.y,n.y),e.upperBound.z=Math.max(f.z,n.z)};var v={faceList:[0]};o.prototype.intersectHeightfield=function(e,f,n,d,i){var l=(e.data,e.elementSize,new t),p=new o(this.from,this.to);u.pointToLocalFrame(n,f,p.from,p.from),u.pointToLocalFrame(n,f,p.to,p.to);var s=[],y=null,c=null,a=null,r=null,w=e.getIndexOfPosition(p.from.x,p.from.y,s,!1);if(w&&(y=s[0],c=s[1],a=s[0],r=s[1]),w=e.getIndexOfPosition(p.to.x,p.to.y,s,!1),w&&((null===y||s[0]<y)&&(y=s[0]),(null===a||s[0]>a)&&(a=s[0]),(null===c||s[1]<c)&&(c=s[1]),(null===r||s[1]>r)&&(r=s[1])),null!==y){var b=[];e.getRectMinMax(y,c,a,r,b);for(var m=(b[0],b[1],y);a>=m;m++)for(var N=c;r>=N;N++){if(this.result._shouldStop)return;if(e.getConvexTrianglePillar(m,N,!1),u.pointToWorldFrame(n,f,e.pillarOffset,l),this.intersectConvex(e.pillarConvex,f,l,d,i,v),this.result._shouldStop)return;e.getConvexTrianglePillar(m,N,!0),u.pointToWorldFrame(n,f,e.pillarOffset,l),this.intersectConvex(e.pillarConvex,f,l,d,i,v)}}},o.prototype[s.types.HEIGHTFIELD]=o.prototype.intersectHeightfield;var A=new t,C=new t;o.prototype.intersectSphere=function(e,f,n,o,d){var i=this.from,t=this.to,l=e.radius,u=Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2)+Math.pow(t.z-i.z,2),p=2*((t.x-i.x)*(i.x-n.x)+(t.y-i.y)*(i.y-n.y)+(t.z-i.z)*(i.z-n.z)),s=Math.pow(i.x-n.x,2)+Math.pow(i.y-n.y,2)+Math.pow(i.z-n.z,2)-Math.pow(l,2),y=Math.pow(p,2)-4*u*s,c=A,a=C;if(!(0>y))if(0===y)i.lerp(t,y,c),c.vsub(n,a),a.normalize(),this.reportIntersection(a,c,d,o,-1);else{var r=(-p-Math.sqrt(y))/(2*u),w=(-p+Math.sqrt(y))/(2*u);if(r>=0&&1>=r&&(i.lerp(t,r,c),c.vsub(n,a),a.normalize(),this.reportIntersection(a,c,d,o,-1)),this.result._shouldStop)return;w>=0&&1>=w&&(i.lerp(t,w,c),c.vsub(n,a),a.normalize(),this.reportIntersection(a,c,d,o,-1))}},o.prototype[s.types.SPHERE]=o.prototype.intersectSphere;var O=new t,h=(new t,new t,new t);o.prototype.intersectConvex=function(e,f,n,o,i,t){for(var l=O,u=h,p=t&&t.faceList||null,s=e.faces,y=e.vertices,c=e.faceNormals,a=this._direction,r=this.from,w=this.to,b=r.distanceTo(w),m=p?p.length:s.length,v=this.result,A=0;!v._shouldStop&&m>A;A++){var C=p?p[A]:A,k=s[C],q=c[C],z=f,B=n;u.copy(y[k[0]]),z.vmult(u,u),u.vadd(B,u),u.vsub(r,u),z.vmult(q,l);var D=a.dot(l);if(!(Math.abs(D)<this.precision)){var E=l.dot(u)/D;if(!(0>E)){a.mult(E,N),N.vadd(r,N),g.copy(y[k[0]]),z.vmult(g,g),B.vadd(g,g);for(var F=1;!v._shouldStop&&F<k.length-1;F++){x.copy(y[k[F]]),j.copy(y[k[F+1]]),z.vmult(x,x),z.vmult(j,j),B.vadd(x,x),B.vadd(j,j);var G=N.distanceTo(r);!d(N,g,x,j)&&!d(N,x,g,j)||G>b||this.reportIntersection(l,N,i,o,C)}}}}},o.prototype[s.types.CONVEXPOLYHEDRON]=o.prototype.intersectConvex;var k=new t,q=new t,z=new t,B=new t,D=new t,E=new t,F=(new y,[]),G=new u;o.prototype.intersectTrimesh=function(e,f,n,o,i,t){var l=k,p=F,s=G,y=h,c=q,a=z,r=B,w=E,b=D,m=(t&&t.faceList||null,e.indices),v=(e.vertices,e.faceNormals,this.from),A=this.to,C=this._direction;s.position.copy(n),s.quaternion.copy(f),u.vectorToLocalFrame(n,f,C,c),u.pointToLocalFrame(n,f,v,a),u.pointToLocalFrame(n,f,A,r),r.x*=e.scale.x,r.y*=e.scale.y,r.z*=e.scale.z,a.x*=e.scale.x,a.y*=e.scale.y,a.z*=e.scale.z,r.vsub(a,c),c.normalize();var O=a.distanceSquared(r);e.tree.rayQuery(this,s,p);for(var H=0,I=p.length;!this.result._shouldStop&&H!==I;H++){var J=p[H];e.getNormal(J,l),e.getVertex(m[3*J],g),g.vsub(a,y);var K=c.dot(l),L=l.dot(y)/K;if(!(0>L)){c.scale(L,N),N.vadd(a,N),e.getVertex(m[3*J+1],x),e.getVertex(m[3*J+2],j);var M=N.distanceSquared(a);!d(N,x,g,j)&&!d(N,g,x,j)||M>O||(u.vectorToWorldFrame(f,l,b),u.pointToWorldFrame(n,f,N,w),this.reportIntersection(b,w,i,o,J))}}p.length=0},o.prototype[s.types.TRIMESH]=o.prototype.intersectTrimesh,o.prototype.reportIntersection=function(e,f,n,d,i){var t=this.from,l=this.to,u=t.distanceTo(f),p=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(p.hitFaceIndex="undefined"!=typeof i?i:-1,this.mode){case o.ALL:this.hasHit=!0,p.set(t,l,e,f,n,d,u),p.hasHit=!0,this.callback(p);break;case o.CLOSEST:(u<p.distance||!p.hasHit)&&(this.hasHit=!0,p.hasHit=!0,p.set(t,l,e,f,n,d,u));break;case o.ANY:this.hasHit=!0,p.hasHit=!0,p.set(t,l,e,f,n,d,u),p._shouldStop=!0}};var H=new t,I=new t},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,f,n){function o(){this.rayFromWorld=new d,this.rayToWorld=new d,this.hitNormalWorld=new d,this.hitPointWorld=new d,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}var d=e("../math/Vec3");f.exports=o,o.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},o.prototype.abort=function(){this._shouldStop=!0},o.prototype.set=function(e,f,n,o,d,i,t){this.rayFromWorld.copy(e),this.rayToWorld.copy(f),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(o),this.shape=d,this.body=i,this.distance=t}},{"../math/Vec3":30}],11:[function(e,f,n){function o(e){d.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var f=this.axisList;this._addBodyHandler=function(e){f.push(e.body)},this._removeBodyHandler=function(e){var n=f.indexOf(e.body);-1!==n&&f.splice(n,1)},e&&this.setWorld(e)}var d=(e("../shapes/Shape"),e("../collision/Broadphase"));f.exports=o,o.prototype=new d,o.prototype.setWorld=function(e){this.axisList.length=0;for(var f=0;f<e.bodies.length;f++)this.axisList.push(e.bodies[f]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},o.insertionSortX=function(e){for(var f=1,n=e.length;n>f;f++){for(var o=e[f],d=f-1;d>=0&&!(e[d].aabb.lowerBound.x<=o.aabb.lowerBound.x);d--)e[d+1]=e[d];e[d+1]=o}return e},o.insertionSortY=function(e){for(var f=1,n=e.length;n>f;f++){for(var o=e[f],d=f-1;d>=0&&!(e[d].aabb.lowerBound.y<=o.aabb.lowerBound.y);d--)e[d+1]=e[d];e[d+1]=o}return e},o.insertionSortZ=function(e){for(var f=1,n=e.length;n>f;f++){for(var o=e[f],d=f-1;d>=0&&!(e[d].aabb.lowerBound.z<=o.aabb.lowerBound.z);d--)e[d+1]=e[d];e[d+1]=o}return e},o.prototype.collisionPairs=function(e,f,n){var d,i,t=this.axisList,l=t.length,u=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),d=0;d!==l;d++){var p=t[d];for(i=d+1;l>i;i++){var s=t[i];if(this.needBroadphaseCollision(p,s)){if(!o.checkBounds(p,s,u))break;this.intersectionTest(p,s,f,n)}}}},o.prototype.sortList=function(){for(var e=this.axisList,f=this.axisIndex,n=e.length,d=0;d!==n;d++){var i=e[d];i.aabbNeedsUpdate&&i.computeAABB()}0===f?o.insertionSortX(e):1===f?o.insertionSortY(e):2===f&&o.insertionSortZ(e)},o.checkBounds=function(e,f,n){var o,d;0===n?(o=e.position.x,d=f.position.x):1===n?(o=e.position.y,d=f.position.y):2===n&&(o=e.position.z,d=f.position.z);var i=e.boundingRadius,t=f.boundingRadius,l=o+i,u=d-t;return l>u},o.prototype.autoDetectAxis=function(){for(var e=0,f=0,n=0,o=0,d=0,i=0,t=this.axisList,l=t.length,u=1/l,p=0;p!==l;p++){var s=t[p],y=s.position.x;e+=y,f+=y*y;var c=s.position.y;n+=c,o+=c*c;var a=s.position.z;d+=a,i+=a*a}var r=f-e*e*u,w=o-n*n*u,b=i-d*d*u;r>w?r>b?this.axisIndex=0:this.axisIndex=2:w>b?this.axisIndex=1:this.axisIndex=2},o.prototype.aabbQuery=function(e,f,n){n=n||[],this.dirty&&(this.sortList(),this.dirty=!1);var o=this.axisIndex,d="x";1===o&&(d="y"),2===o&&(d="z");for(var i=this.axisList,t=(f.lowerBound[d],f.upperBound[d],0);t<i.length;t++){var l=i[t];l.aabbNeedsUpdate&&l.computeAABB(),l.aabb.overlaps(f)&&n.push(l)}return n}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,f,n){function o(e,f,n){n=n||{};var o="undefined"!=typeof n.maxForce?n.maxForce:1e6,u=n.pivotA?n.pivotA.clone():new l,p=n.pivotB?n.pivotB.clone():new l;this.axisA=n.axisA?n.axisA.clone():new l,this.axisB=n.axisB?n.axisB.clone():new l,d.call(this,e,u,f,p,o),this.collideConnected=!!n.collideConnected,this.angle="undefined"!=typeof n.angle?n.angle:0;var s=this.coneEquation=new i(e,f,n),y=this.twistEquation=new t(e,f,n);this.twistAngle="undefined"!=typeof n.twistAngle?n.twistAngle:0,s.maxForce=0,s.minForce=-o,y.maxForce=0,y.minForce=-o,this.equations.push(s,y)}f.exports=o;var d=(e("./Constraint"),e("./PointToPointConstraint")),i=e("../equations/ConeEquation"),t=e("../equations/RotationalEquation"),l=(e("../equations/ContactEquation"),e("../math/Vec3"));o.prototype=new d,o.constructor=o;new l,new l;o.prototype.update=function(){var e=this.bodyA,f=this.bodyB,n=this.coneEquation,o=this.twistEquation;d.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,n.axisA),f.vectorToWorldFrame(this.axisB,n.axisB),this.axisA.tangents(o.axisA,o.axisA),e.vectorToWorldFrame(o.axisA,o.axisA),this.axisB.tangents(o.axisB,o.axisB),f.vectorToWorldFrame(o.axisB,o.axisB),n.angle=this.angle,o.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,f,n){function o(e,f,n){n=d.defaults(n,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=f,this.id=o.idCounter++,this.collideConnected=n.collideConnected,n.wakeUpBodies&&(e&&e.wakeUp(),f&&f.wakeUp())}f.exports=o;var d=e("../utils/Utils");o.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},o.prototype.enable=function(){for(var e=this.equations,f=0;f<e.length;f++)e[f].enabled=!0},o.prototype.disable=function(){for(var e=this.equations,f=0;f<e.length;f++)e[f].enabled=!1},o.idCounter=0},{"../utils/Utils":53}],14:[function(e,f,n){function o(e,f,n,o){d.call(this,e,f),"undefined"==typeof n&&(n=e.position.distanceTo(f.position)),"undefined"==typeof o&&(o=1e6),this.distance=n;var t=this.distanceEquation=new i(e,f);this.equations.push(t),t.minForce=-o,t.maxForce=o}f.exports=o;var d=e("./Constraint"),i=e("../equations/ContactEquation");o.prototype=new d,o.prototype.update=function(){var e=this.bodyA,f=this.bodyB,n=this.distanceEquation,o=.5*this.distance,d=n.ni;f.position.vsub(e.position,d),d.normalize(),d.mult(o,n.ri),d.mult(-o,n.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,f,n){function o(e,f,n){n=n||{};var o="undefined"!=typeof n.maxForce?n.maxForce:1e6,u=n.pivotA?n.pivotA.clone():new l,p=n.pivotB?n.pivotB.clone():new l;d.call(this,e,u,f,p,o);var s=this.axisA=n.axisA?n.axisA.clone():new l(1,0,0);s.normalize();var y=this.axisB=n.axisB?n.axisB.clone():new l(1,0,0);y.normalize();var c=this.rotationalEquation1=new i(e,f,n),a=this.rotationalEquation2=new i(e,f,n),r=this.motorEquation=new t(e,f,o);r.enabled=!1,this.equations.push(c,a,r)}f.exports=o;var d=(e("./Constraint"),e("./PointToPointConstraint")),i=e("../equations/RotationalEquation"),t=e("../equations/RotationalMotorEquation"),l=(e("../equations/ContactEquation"),e("../math/Vec3"));o.prototype=new d,o.constructor=o,o.prototype.enableMotor=function(){this.motorEquation.enabled=!0},o.prototype.disableMotor=function(){this.motorEquation.enabled=!1},o.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},o.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var u=new l,p=new l;o.prototype.update=function(){var e=this.bodyA,f=this.bodyB,n=this.motorEquation,o=this.rotationalEquation1,i=this.rotationalEquation2,t=u,l=p,s=this.axisA,y=this.axisB;d.prototype.update.call(this),e.quaternion.vmult(s,t),f.quaternion.vmult(y,l),t.tangents(o.axisA,i.axisA),o.axisB.copy(l),i.axisB.copy(l),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,n.axisA),f.quaternion.vmult(this.axisB,n.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,f,n){function o(e,f,n){n=n||{};var o="undefined"!=typeof n.maxForce?n.maxForce:1e6,l=new t,u=new t,p=new t;e.position.vadd(f.position,p),p.scale(.5,p),f.pointToLocalFrame(p,u),e.pointToLocalFrame(p,l),d.call(this,e,l,f,u,o),this.xA=e.vectorToLocalFrame(t.UNIT_X),this.xB=f.vectorToLocalFrame(t.UNIT_X),this.yA=e.vectorToLocalFrame(t.UNIT_Y),this.yB=f.vectorToLocalFrame(t.UNIT_Y),this.zA=e.vectorToLocalFrame(t.UNIT_Z),this.zB=f.vectorToLocalFrame(t.UNIT_Z);var s=this.rotationalEquation1=new i(e,f,n),y=this.rotationalEquation2=new i(e,f,n),c=this.rotationalEquation3=new i(e,f,n);this.equations.push(s,y,c)}f.exports=o;var d=(e("./Constraint"),e("./PointToPointConstraint")),i=e("../equations/RotationalEquation"),t=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));o.prototype=new d,o.constructor=o;new t,new t;o.prototype.update=function(){var e=this.bodyA,f=this.bodyB,n=(this.motorEquation,this.rotationalEquation1),o=this.rotationalEquation2,i=this.rotationalEquation3;d.prototype.update.call(this),e.vectorToWorldFrame(this.xA,n.axisA),f.vectorToWorldFrame(this.yB,n.axisB),e.vectorToWorldFrame(this.yA,o.axisA),f.vectorToWorldFrame(this.zB,o.axisB),e.vectorToWorldFrame(this.zA,i.axisA),f.vectorToWorldFrame(this.xB,i.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,f,n){function o(e,f,n,o,l){d.call(this,e,n),l="undefined"!=typeof l?l:1e6,this.pivotA=f?f.clone():new t,this.pivotB=o?o.clone():new t;var u=this.equationX=new i(e,n),p=this.equationY=new i(e,n),s=this.equationZ=new i(e,n);this.equations.push(u,p,s),u.minForce=p.minForce=s.minForce=-l,u.maxForce=p.maxForce=s.maxForce=l,u.ni.set(1,0,0),p.ni.set(0,1,0),s.ni.set(0,0,1)}f.exports=o;var d=e("./Constraint"),i=e("../equations/ContactEquation"),t=e("../math/Vec3");o.prototype=new d,o.prototype.update=function(){var e=this.bodyA,f=this.bodyB,n=this.equationX,o=this.equationY,d=this.equationZ;e.quaternion.vmult(this.pivotA,n.ri),f.quaternion.vmult(this.pivotB,n.rj),o.ri.copy(n.ri),o.rj.copy(n.rj),d.ri.copy(n.ri),d.rj.copy(n.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,f,n){function o(e,f,n){n=n||{};var o="undefined"!=typeof n.maxForce?n.maxForce:1e6;i.call(this,e,f,-o,o),this.axisA=n.axisA?n.axisA.clone():new d(1,0,0),this.axisB=n.axisB?n.axisB.clone():new d(0,1,0),this.angle="undefined"!=typeof n.angle?n.angle:0}f.exports=o;var d=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));o.prototype=new i,o.prototype.constructor=o;var t=new d,l=new d;o.prototype.computeB=function(e){var f=this.a,n=this.b,o=this.axisA,d=this.axisB,i=t,u=l,p=this.jacobianElementA,s=this.jacobianElementB;o.cross(d,i),d.cross(o,u),p.rotational.copy(u),s.rotational.copy(i);var y=Math.cos(this.angle)-o.dot(d),c=this.computeGW(),a=this.computeGiMf(),r=-y*f-c*n-e*a;return r}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,f,n){function o(e,f,n){n="undefined"!=typeof n?n:1e6,d.call(this,e,f,0,n),this.restitution=0,this.ri=new i,this.rj=new i,this.ni=new i}f.exports=o;var d=e("./Equation"),i=e("../math/Vec3");e("../math/Mat3");o.prototype=new d,o.prototype.constructor=o;var t=new i,l=new i,u=new i;o.prototype.computeB=function(e){var f=this.a,n=this.b,o=this.bi,d=this.bj,i=this.ri,p=this.rj,s=t,y=l,c=o.velocity,a=o.angularVelocity,r=(o.force,o.torque,d.velocity),w=d.angularVelocity,b=(d.force,d.torque,u),m=this.jacobianElementA,N=this.jacobianElementB,g=this.ni;i.cross(g,s),p.cross(g,y),g.negate(m.spatial),s.negate(m.rotational),N.spatial.copy(g),N.rotational.copy(y),b.copy(d.position),b.vadd(p,b),b.vsub(o.position,b),b.vsub(i,b);
var x=g.dot(b),j=this.restitution+1,v=j*r.dot(g)-j*c.dot(g)+w.dot(y)-a.dot(s),A=this.computeGiMf(),C=-x*f-v*n-e*A;return C};var p=new i,s=new i,y=new i,c=new i,a=new i;o.prototype.getImpactVelocityAlongNormal=function(){var e=p,f=s,n=y,o=c,d=a;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,o),this.bi.getVelocityAtWorldPoint(n,e),this.bj.getVelocityAtWorldPoint(o,f),e.vsub(f,d),this.ni.dot(d)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,f,n){function o(e,f,n,i){this.id=o.id++,this.minForce="undefined"==typeof n?-1e6:n,this.maxForce="undefined"==typeof i?1e6:i,this.bi=e,this.bj=f,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new d,this.jacobianElementB=new d,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}f.exports=o;var d=e("../math/JacobianElement"),i=e("../math/Vec3");o.prototype.constructor=o,o.id=0,o.prototype.setSpookParams=function(e,f,n){var o=f,d=e,i=n;this.a=4/(i*(1+4*o)),this.b=4*o/(1+4*o),this.eps=4/(i*i*d*(1+4*o))},o.prototype.computeB=function(e,f,n){var o=this.computeGW(),d=this.computeGq(),i=this.computeGiMf();return-d*e-o*f-i*n},o.prototype.computeGq=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.position,i=o.position;return e.spatial.dot(d)+f.spatial.dot(i)};new i;o.prototype.computeGW=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.velocity,i=o.velocity,t=n.angularVelocity,l=o.angularVelocity;return e.multiplyVectors(d,t)+f.multiplyVectors(i,l)},o.prototype.computeGWlambda=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.vlambda,i=o.vlambda,t=n.wlambda,l=o.wlambda;return e.multiplyVectors(d,t)+f.multiplyVectors(i,l)};var t=new i,l=new i,u=new i,p=new i;o.prototype.computeGiMf=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.force,i=n.torque,s=o.force,y=o.torque,c=n.invMassSolve,a=o.invMassSolve;return d.scale(c,t),s.scale(a,l),n.invInertiaWorldSolve.vmult(i,u),o.invInertiaWorldSolve.vmult(y,p),e.multiplyVectors(t,u)+f.multiplyVectors(l,p)};var s=new i;o.prototype.computeGiMGt=function(){var e=this.jacobianElementA,f=this.jacobianElementB,n=this.bi,o=this.bj,d=n.invMassSolve,i=o.invMassSolve,t=n.invInertiaWorldSolve,l=o.invInertiaWorldSolve,u=d+i;return t.vmult(e.rotational,s),u+=s.dot(e.rotational),l.vmult(f.rotational,s),u+=s.dot(f.rotational)};var y=new i;new i,new i,new i,new i,new i;o.prototype.addToWlambda=function(e){var f=this.jacobianElementA,n=this.jacobianElementB,o=this.bi,d=this.bj,i=y;o.vlambda.addScaledVector(o.invMassSolve*e,f.spatial,o.vlambda),d.vlambda.addScaledVector(d.invMassSolve*e,n.spatial,d.vlambda),o.invInertiaWorldSolve.vmult(f.rotational,i),o.wlambda.addScaledVector(e,i,o.wlambda),d.invInertiaWorldSolve.vmult(n.rotational,i),d.wlambda.addScaledVector(e,i,d.wlambda)},o.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,f,n){function o(e,f,n){d.call(this,e,f,-n,n),this.ri=new i,this.rj=new i,this.t=new i}f.exports=o;var d=e("./Equation"),i=e("../math/Vec3");e("../math/Mat3");o.prototype=new d,o.prototype.constructor=o;var t=new i,l=new i;o.prototype.computeB=function(e){var f=(this.a,this.b),n=(this.bi,this.bj,this.ri),o=this.rj,d=t,i=l,u=this.t;n.cross(u,d),o.cross(u,i);var p=this.jacobianElementA,s=this.jacobianElementB;u.negate(p.spatial),d.negate(p.rotational),s.spatial.copy(u),s.rotational.copy(i);var y=this.computeGW(),c=this.computeGiMf(),a=-y*f-e*c;return a}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,f,n){function o(e,f,n){n=n||{};var o="undefined"!=typeof n.maxForce?n.maxForce:1e6;i.call(this,e,f,-o,o),this.axisA=n.axisA?n.axisA.clone():new d(1,0,0),this.axisB=n.axisB?n.axisB.clone():new d(0,1,0),this.maxAngle=Math.PI/2}f.exports=o;var d=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));o.prototype=new i,o.prototype.constructor=o;var t=new d,l=new d;o.prototype.computeB=function(e){var f=this.a,n=this.b,o=this.axisA,d=this.axisB,i=t,u=l,p=this.jacobianElementA,s=this.jacobianElementB;o.cross(d,i),d.cross(o,u),p.rotational.copy(u),s.rotational.copy(i);var y=Math.cos(this.maxAngle)-o.dot(d),c=this.computeGW(),a=this.computeGiMf(),r=-y*f-c*n-e*a;return r}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,f,n){function o(e,f,n){n="undefined"!=typeof n?n:1e6,i.call(this,e,f,-n,n),this.axisA=new d,this.axisB=new d,this.targetVelocity=0}f.exports=o;var d=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));o.prototype=new i,o.prototype.constructor=o,o.prototype.computeB=function(e){var f=(this.a,this.b),n=(this.bi,this.bj,this.axisA),o=this.axisB,d=this.jacobianElementA,i=this.jacobianElementB;d.rotational.copy(n),o.negate(i.rotational);var t=this.computeGW()-this.targetVelocity,l=this.computeGiMf(),u=-t*f-e*l;return u}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,f,n){function o(e,f,n){n=d.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=o.idCounter++,this.materials=[e,f],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}var d=e("../utils/Utils");f.exports=o,o.idCounter=0},{"../utils/Utils":53}],25:[function(e,f,n){function o(e){var f="";e=e||{},"string"==typeof e?(f=e,e={}):"object"==typeof e&&(f=""),this.name=f,this.id=o.idCounter++,this.friction="undefined"!=typeof e.friction?e.friction:-1,this.restitution="undefined"!=typeof e.restitution?e.restitution:-1}f.exports=o,o.idCounter=0},{}],26:[function(e,f,n){function o(){this.spatial=new d,this.rotational=new d}f.exports=o;var d=e("./Vec3");o.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},o.prototype.multiplyVectors=function(e,f){return e.dot(this.spatial)+f.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,f,n){function o(e){e?this.elements=e:this.elements=[0,0,0,0,0,0,0,0,0]}f.exports=o;var d=e("./Vec3");o.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},o.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},o.prototype.setTrace=function(e){var f=this.elements;f[0]=e.x,f[4]=e.y,f[8]=e.z},o.prototype.getTrace=function(e){var e=e||new d,f=this.elements;e.x=f[0],e.y=f[4],e.z=f[8]},o.prototype.vmult=function(e,f){f=f||new d;var n=this.elements,o=e.x,i=e.y,t=e.z;return f.x=n[0]*o+n[1]*i+n[2]*t,f.y=n[3]*o+n[4]*i+n[5]*t,f.z=n[6]*o+n[7]*i+n[8]*t,f},o.prototype.smult=function(e){for(var f=0;f<this.elements.length;f++)this.elements[f]*=e},o.prototype.mmult=function(e,f){for(var n=f||new o,d=0;3>d;d++)for(var i=0;3>i;i++){for(var t=0,l=0;3>l;l++)t+=e.elements[d+3*l]*this.elements[l+3*i];n.elements[d+3*i]=t}return n},o.prototype.scale=function(e,f){f=f||new o;for(var n=this.elements,d=f.elements,i=0;3!==i;i++)d[3*i+0]=e.x*n[3*i+0],d[3*i+1]=e.y*n[3*i+1],d[3*i+2]=e.z*n[3*i+2];return f},o.prototype.solve=function(e,f){f=f||new d;for(var n=3,o=4,i=[],t=0;n*o>t;t++)i.push(0);var t,l;for(t=0;3>t;t++)for(l=0;3>l;l++)i[t+o*l]=this.elements[t+3*l];i[3]=e.x,i[7]=e.y,i[11]=e.z;var u,p,s=3,y=s,c=4;do{if(t=y-s,0===i[t+o*t])for(l=t+1;y>l;l++)if(0!==i[t+o*l]){u=c;do p=c-u,i[p+o*t]+=i[p+o*l];while(--u);break}if(0!==i[t+o*t])for(l=t+1;y>l;l++){var a=i[t+o*l]/i[t+o*t];u=c;do p=c-u,i[p+o*l]=t>=p?0:i[p+o*l]-i[p+o*t]*a;while(--u)}}while(--s);if(f.z=i[2*o+3]/i[2*o+2],f.y=(i[1*o+3]-i[1*o+2]*f.z)/i[1*o+1],f.x=(i[0*o+3]-i[0*o+2]*f.z-i[0*o+1]*f.y)/i[0*o+0],isNaN(f.x)||isNaN(f.y)||isNaN(f.z)||f.x===1/0||f.y===1/0||f.z===1/0)throw"Could not solve equation! Got x=["+f.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return f},o.prototype.e=function(e,f,n){return void 0===n?this.elements[f+3*e]:void(this.elements[f+3*e]=n)},o.prototype.copy=function(e){for(var f=0;f<e.elements.length;f++)this.elements[f]=e.elements[f];return this},o.prototype.toString=function(){for(var e="",f=",",n=0;9>n;n++)e+=this.elements[n]+f;return e},o.prototype.reverse=function(e){e=e||new o;for(var f=3,n=6,d=[],i=0;f*n>i;i++)d.push(0);var i,t;for(i=0;3>i;i++)for(t=0;3>t;t++)d[i+n*t]=this.elements[i+3*t];d[3]=1,d[9]=0,d[15]=0,d[4]=0,d[10]=1,d[16]=0,d[5]=0,d[11]=0,d[17]=1;var l,u,p=3,s=p,y=n;do{if(i=s-p,0===d[i+n*i])for(t=i+1;s>t;t++)if(0!==d[i+n*t]){l=y;do u=y-l,d[u+n*i]+=d[u+n*t];while(--l);break}if(0!==d[i+n*i])for(t=i+1;s>t;t++){var c=d[i+n*t]/d[i+n*i];l=y;do u=y-l,d[u+n*t]=i>=u?0:d[u+n*t]-d[u+n*i]*c;while(--l)}}while(--p);i=2;do{t=i-1;do{var c=d[i+n*t]/d[i+n*i];l=n;do u=n-l,d[u+n*t]=d[u+n*t]-d[u+n*i]*c;while(--l)}while(t--)}while(--i);i=2;do{var c=1/d[i+n*i];l=n;do u=n-l,d[u+n*i]=d[u+n*i]*c;while(--l)}while(i--);i=2;do{t=2;do{if(u=d[f+t+n*i],isNaN(u)||u===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(i,t,u)}while(t--)}while(i--);return e},o.prototype.setRotationFromQuaternion=function(e){var f=e.x,n=e.y,o=e.z,d=e.w,i=f+f,t=n+n,l=o+o,u=f*i,p=f*t,s=f*l,y=n*t,c=n*l,a=o*l,r=d*i,w=d*t,b=d*l,m=this.elements;return m[0]=1-(y+a),m[1]=p-b,m[2]=s+w,m[3]=p+b,m[4]=1-(u+a),m[5]=c-r,m[6]=s-w,m[7]=c+r,m[8]=1-(u+y),this},o.prototype.transpose=function(e){e=e||new o;for(var f=e.elements,n=this.elements,d=0;3!==d;d++)for(var i=0;3!==i;i++)f[3*d+i]=n[3*i+d];return e}},{"./Vec3":30}],28:[function(e,f,n){function o(e,f,n,o){this.x=void 0!==e?e:0,this.y=void 0!==f?f:0,this.z=void 0!==n?n:0,this.w=void 0!==o?o:1}f.exports=o;var d=e("./Vec3");o.prototype.set=function(e,f,n,o){return this.x=e,this.y=f,this.z=n,this.w=o,this},o.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},o.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},o.prototype.setFromAxisAngle=function(e,f){var n=Math.sin(.5*f);return this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(.5*f),this},o.prototype.toAxisAngle=function(e){e=e||new d,this.normalize();var f=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return.001>n?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,f]};var i=new d,t=new d;o.prototype.setFromVectors=function(e,f){if(e.isAntiparallelTo(f)){var n=i,o=t;e.tangents(n,o),this.setFromAxisAngle(n,Math.PI)}else{var d=e.cross(f);this.x=d.x,this.y=d.y,this.z=d.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(f.norm(),2))+e.dot(f),this.normalize()}return this};new d,new d,new d;o.prototype.mult=function(e,f){f=f||new o;var n=this.x,d=this.y,i=this.z,t=this.w,l=e.x,u=e.y,p=e.z,s=e.w;return f.x=n*s+t*l+d*p-i*u,f.y=d*s+t*u+i*l-n*p,f.z=i*s+t*p+n*u-d*l,f.w=t*s-n*l-d*u-i*p,f},o.prototype.inverse=function(e){var f=this.x,n=this.y,d=this.z,i=this.w;e=e||new o,this.conjugate(e);var t=1/(f*f+n*n+d*d+i*i);return e.x*=t,e.y*=t,e.z*=t,e.w*=t,e},o.prototype.conjugate=function(e){return e=e||new o,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},o.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},o.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},o.prototype.vmult=function(e,f){f=f||new d;var n=e.x,o=e.y,i=e.z,t=this.x,l=this.y,u=this.z,p=this.w,s=p*n+l*i-u*o,y=p*o+u*n-t*i,c=p*i+t*o-l*n,a=-t*n-l*o-u*i;return f.x=s*p+a*-t+y*-u-c*-l,f.y=y*p+a*-l+c*-t-s*-u,f.z=c*p+a*-u+s*-l-y*-t,f},o.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},o.prototype.toEuler=function(e,f){f=f||"YZX";var n,o,d,i=this.x,t=this.y,l=this.z,u=this.w;switch(f){case"YZX":var p=i*t+l*u;if(p>.499&&(n=2*Math.atan2(i,u),o=Math.PI/2,d=0),-.499>p&&(n=-2*Math.atan2(i,u),o=-Math.PI/2,d=0),isNaN(n)){var s=i*i,y=t*t,c=l*l;n=Math.atan2(2*t*u-2*i*l,1-2*y-2*c),o=Math.asin(2*p),d=Math.atan2(2*i*u-2*t*l,1-2*s-2*c)}break;default:throw new Error("Euler order "+f+" not supported yet.")}e.y=n,e.z=o,e.x=d},o.prototype.setFromEuler=function(e,f,n,o){o=o||"XYZ";var d=Math.cos(e/2),i=Math.cos(f/2),t=Math.cos(n/2),l=Math.sin(e/2),u=Math.sin(f/2),p=Math.sin(n/2);return"XYZ"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t-l*u*p):"YXZ"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t+l*u*p):"ZXY"===o?(this.x=l*i*t-d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t-l*u*p):"ZYX"===o?(this.x=l*i*t-d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t+l*u*p):"YZX"===o?(this.x=l*i*t+d*u*p,this.y=d*u*t+l*i*p,this.z=d*i*p-l*u*t,this.w=d*i*t-l*u*p):"XZY"===o&&(this.x=l*i*t-d*u*p,this.y=d*u*t-l*i*p,this.z=d*i*p+l*u*t,this.w=d*i*t+l*u*p),this},o.prototype.clone=function(){return new o(this.x,this.y,this.z,this.w)},o.prototype.slerp=function(e,f,n){n=n||new o;var d,i,t,l,u,p=this.x,s=this.y,y=this.z,c=this.w,a=e.x,r=e.y,w=e.z,b=e.w;return i=p*a+s*r+y*w+c*b,0>i&&(i=-i,a=-a,r=-r,w=-w,b=-b),1-i>1e-6?(d=Math.acos(i),t=Math.sin(d),l=Math.sin((1-f)*d)/t,u=Math.sin(f*d)/t):(l=1-f,u=f),n.x=l*p+u*a,n.y=l*s+u*r,n.z=l*y+u*w,n.w=l*c+u*b,n},o.prototype.integrate=function(e,f,n,d){d=d||new o;var i=e.x*n.x,t=e.y*n.y,l=e.z*n.z,u=this.x,p=this.y,s=this.z,y=this.w,c=.5*f;return d.x+=c*(i*y+t*s-l*p),d.y+=c*(t*y+l*u-i*s),d.z+=c*(l*y+i*p-t*u),d.w+=c*(-i*u-t*p-l*s),d}},{"./Vec3":30}],29:[function(e,f,n){function o(e){e=e||{},this.position=new d,e.position&&this.position.copy(e.position),this.quaternion=new i,e.quaternion&&this.quaternion.copy(e.quaternion)}var d=e("./Vec3"),i=e("./Quaternion");f.exports=o;var t=new i;o.pointToLocalFrame=function(e,f,n,o){var o=o||new d;return n.vsub(e,o),f.conjugate(t),t.vmult(o,o),o},o.prototype.pointToLocal=function(e,f){return o.pointToLocalFrame(this.position,this.quaternion,e,f)},o.pointToWorldFrame=function(e,f,n,o){var o=o||new d;return f.vmult(n,o),o.vadd(e,o),o},o.prototype.pointToWorld=function(e,f){return o.pointToWorldFrame(this.position,this.quaternion,e,f)},o.prototype.vectorToWorldFrame=function(e,f){var f=f||new d;return this.quaternion.vmult(e,f),f},o.vectorToWorldFrame=function(e,f,n){return e.vmult(f,n),n},o.vectorToLocalFrame=function(e,f,n,o){var o=o||new d;return f.w*=-1,f.vmult(n,o),f.w*=-1,o}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,f,n){function o(e,f,n){this.x=e||0,this.y=f||0,this.z=n||0}f.exports=o;var d=e("./Mat3");o.ZERO=new o(0,0,0),o.UNIT_X=new o(1,0,0),o.UNIT_Y=new o(0,1,0),o.UNIT_Z=new o(0,0,1),o.prototype.cross=function(e,f){var n=e.x,d=e.y,i=e.z,t=this.x,l=this.y,u=this.z;return f=f||new o,f.x=l*i-u*d,f.y=u*n-t*i,f.z=t*d-l*n,f},o.prototype.set=function(e,f,n){return this.x=e,this.y=f,this.z=n,this},o.prototype.setZero=function(){this.x=this.y=this.z=0},o.prototype.vadd=function(e,f){return f?(f.x=e.x+this.x,f.y=e.y+this.y,f.z=e.z+this.z,void 0):new o(this.x+e.x,this.y+e.y,this.z+e.z)},o.prototype.vsub=function(e,f){return f?(f.x=this.x-e.x,f.y=this.y-e.y,f.z=this.z-e.z,void 0):new o(this.x-e.x,this.y-e.y,this.z-e.z)},o.prototype.crossmat=function(){return new d([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},o.prototype.normalize=function(){var e=this.x,f=this.y,n=this.z,o=Math.sqrt(e*e+f*f+n*n);if(o>0){var d=1/o;this.x*=d,this.y*=d,this.z*=d}else this.x=0,this.y=0,this.z=0;return o},o.prototype.unit=function(e){e=e||new o;var f=this.x,n=this.y,d=this.z,i=Math.sqrt(f*f+n*n+d*d);return i>0?(i=1/i,e.x=f*i,e.y=n*i,e.z=d*i):(e.x=1,e.y=0,e.z=0),e},o.prototype.norm=function(){var e=this.x,f=this.y,n=this.z;return Math.sqrt(e*e+f*f+n*n)},o.prototype.length=o.prototype.norm,o.prototype.norm2=function(){return this.dot(this)},o.prototype.lengthSquared=o.prototype.norm2,o.prototype.distanceTo=function(e){var f=this.x,n=this.y,o=this.z,d=e.x,i=e.y,t=e.z;return Math.sqrt((d-f)*(d-f)+(i-n)*(i-n)+(t-o)*(t-o))},o.prototype.distanceSquared=function(e){var f=this.x,n=this.y,o=this.z,d=e.x,i=e.y,t=e.z;return(d-f)*(d-f)+(i-n)*(i-n)+(t-o)*(t-o)},o.prototype.mult=function(e,f){f=f||new o;var n=this.x,d=this.y,i=this.z;return f.x=e*n,f.y=e*d,f.z=e*i,f},o.prototype.vmul=function(e,f){return f=f||new o,f.x=e.x*this.x,f.y=e.y*this.y,f.z=e.z*this.z,f},o.prototype.scale=o.prototype.mult,o.prototype.addScaledVector=function(e,f,n){return n=n||new o,n.x=this.x+e*f.x,n.y=this.y+e*f.y,n.z=this.z+e*f.z,n},o.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},o.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},o.prototype.negate=function(e){return e=e||new o,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var i=new o,t=new o;o.prototype.tangents=function(e,f){var n=this.norm();if(n>0){var o=i,d=1/n;o.set(this.x*d,this.y*d,this.z*d);var l=t;Math.abs(o.x)<.9?(l.set(1,0,0),o.cross(l,e)):(l.set(0,1,0),o.cross(l,e)),o.cross(e,f)}else e.set(1,0,0),f.set(0,1,0)},o.prototype.toString=function(){return this.x+","+this.y+","+this.z},o.prototype.toArray=function(){return[this.x,this.y,this.z]},o.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},o.prototype.lerp=function(e,f,n){var o=this.x,d=this.y,i=this.z;n.x=o+(e.x-o)*f,n.y=d+(e.y-d)*f,n.z=i+(e.z-i)*f},o.prototype.almostEquals=function(e,f){return void 0===f&&(f=1e-6),Math.abs(this.x-e.x)>f||Math.abs(this.y-e.y)>f||Math.abs(this.z-e.z)>f?!1:!0},o.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e?!1:!0};var l=new o;o.prototype.isAntiparallelTo=function(e,f){return this.negate(l),l.almostEquals(e,f)},o.prototype.clone=function(){return new o(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,f,n){function o(e){e=e||{},d.apply(this),this.id=o.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new i,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:1,this.collisionResponse=!0,this.position=new i,this.previousPosition=new i,this.interpolatedPosition=new i,this.initPosition=new i,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new i,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new i,this.force=new i;var f="number"==typeof e.mass?e.mass:0;this.mass=f,this.invMass=f>0?1/f:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=0>=f?o.STATIC:o.DYNAMIC,typeof e.type==typeof o.STATIC&&(this.type=e.type),this.allowSleep="undefined"!=typeof e.allowSleep?e.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit="undefined"!=typeof e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit="undefined"!=typeof e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new i,this.quaternion=new l,this.initQuaternion=new l,this.previousQuaternion=new l,this.interpolatedQuaternion=new l,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new i,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new i,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new i,this.invInertia=new i,this.invInertiaWorld=new t,this.invMassSolve=0,this.invInertiaSolve=new i,this.invInertiaWorldSolve=new t,this.fixedRotation="undefined"!=typeof e.fixedRotation?e.fixedRotation:!1,this.angularDamping="undefined"!=typeof e.angularDamping?e.angularDamping:.01,this.linearFactor=new i(1,1,1),this.angularFactor=new i(1,1,1),this.aabb=new u,this.aabbNeedsUpdate=!0,this.wlambda=new i,e.shape&&this.addShape(e.shape),this.updateMassProperties()}f.exports=o;var d=e("../utils/EventTarget"),i=(e("../shapes/Shape"),e("../math/Vec3")),t=e("../math/Mat3"),l=e("../math/Quaternion"),u=(e("../material/Material"),e("../collision/AABB")),p=e("../shapes/Box");o.prototype=new d,o.prototype.constructor=o,o.COLLIDE_EVENT_NAME="collide",o.DYNAMIC=1,o.STATIC=2,o.KINEMATIC=4,o.AWAKE=0,o.SLEEPY=1,o.SLEEPING=2,o.idCounter=0,o.wakeupEvent={type:"wakeup"},o.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,e===o.SLEEPING&&this.dispatchEvent(o.wakeupEvent)},o.prototype.sleep=function(){this.sleepState=o.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},o.sleepyEvent={type:"sleepy"},o.sleepEvent={type:"sleep"},o.prototype.sleepTick=function(e){if(this.allowSleep){var f=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),d=Math.pow(this.sleepSpeedLimit,2);f===o.AWAKE&&d>n?(this.sleepState=o.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(o.sleepyEvent)):f===o.SLEEPY&&n>d?this.wakeUp():f===o.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(o.sleepEvent))}},o.prototype.updateSolveMassProperties=function(){this.sleepState===o.SLEEPING||this.type===o.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},o.prototype.pointToLocalFrame=function(e,f){var f=f||new i;return e.vsub(this.position,f),this.quaternion.conjugate().vmult(f,f),f},o.prototype.vectorToLocalFrame=function(e,f){var f=f||new i;return this.quaternion.conjugate().vmult(e,f),f},o.prototype.pointToWorldFrame=function(e,f){var f=f||new i;return this.quaternion.vmult(e,f),f.vadd(this.position,f),f},o.prototype.vectorToWorldFrame=function(e,f){var f=f||new i;return this.quaternion.vmult(e,f),f};var s=new i,y=new l;o.prototype.addShape=function(e,f,n){var o=new i,d=new l;return f&&o.copy(f),n&&d.copy(n),this.shapes.push(e),this.shapeOffsets.push(o),this.shapeOrientations.push(d),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},o.prototype.updateBoundingRadius=function(){for(var e=this.shapes,f=this.shapeOffsets,n=e.length,o=0,d=0;d!==n;d++){var i=e[d];i.updateBoundingSphereRadius();var t=f[d].norm(),l=i.boundingSphereRadius;t+l>o&&(o=t+l)}this.boundingRadius=o};var c=new u;o.prototype.computeAABB=function(){for(var e=this.shapes,f=this.shapeOffsets,n=this.shapeOrientations,o=e.length,d=s,i=y,t=this.quaternion,l=this.aabb,u=c,p=0;p!==o;p++){var a=e[p];t.vmult(f[p],d),d.vadd(this.position,d),n[p].mult(t,i),a.calculateWorldAABB(d,i,u.lowerBound,u.upperBound),0===p?l.copy(u):l.extend(u)}this.aabbNeedsUpdate=!1};var a=new t,r=new t;new t;o.prototype.updateInertiaWorld=function(e){var f=this.invInertia;if(f.x!==f.y||f.y!==f.z||e){var n=a,o=r;n.setRotationFromQuaternion(this.quaternion),n.transpose(o),n.scale(f,n),n.mmult(o,this.invInertiaWorld)}else;};var w=(new i,new i);o.prototype.applyForce=function(e,f){if(this.type===o.DYNAMIC){var n=w;f.cross(e,n),this.force.vadd(e,this.force),this.torque.vadd(n,this.torque)}};var b=new i,m=new i;o.prototype.applyLocalForce=function(e,f){if(this.type===o.DYNAMIC){var n=b,d=m;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(f,d),this.applyForce(n,d)}};var N=(new i,new i),g=new i;o.prototype.applyImpulse=function(e,f){if(this.type===o.DYNAMIC){var n=f,d=N;d.copy(e),d.mult(this.invMass,d),this.velocity.vadd(d,this.velocity);var i=g;n.cross(e,i),this.invInertiaWorld.vmult(i,i),this.angularVelocity.vadd(i,this.angularVelocity)}};var x=new i,j=new i;o.prototype.applyLocalImpulse=function(e,f){if(this.type===o.DYNAMIC){var n=x,d=j;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(f,d),this.applyImpulse(n,d)}};var v=new i;o.prototype.updateMassProperties=function(){var e=v;this.invMass=this.mass>0?1/this.mass:0;var f=this.inertia,n=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),p.calculateInertia(e,this.mass,f),this.invInertia.set(f.x>0&&!n?1/f.x:0,f.y>0&&!n?1/f.y:0,f.z>0&&!n?1/f.z:0),this.updateInertiaWorld(!0)},o.prototype.getVelocityAtWorldPoint=function(e,f){var n=new i;return e.vsub(this.position,n),this.angularVelocity.cross(n,f),this.velocity.vadd(f,f),f};new i,new i,new l,new l;o.prototype.integrate=function(e,f,n){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===o.DYNAMIC||this.type===o.KINEMATIC)&&this.sleepState!==o.SLEEPING){var d=this.velocity,i=this.angularVelocity,t=this.position,l=this.force,u=this.torque,p=this.quaternion,s=this.invMass,y=this.invInertiaWorld,c=this.linearFactor;d.x+=l.x*s*e*c.x,d.y+=l.y*s*e*c.y,d.z+=l.z*s*e*c.z;var a=y.elements;i.x+=e*(a[0]*u.x+a[1]*u.y+a[2]*u.z),i.y+=e*(a[3]*u.x+a[4]*u.y+a[5]*u.z),i.z+=e*(a[6]*u.x+a[7]*u.y+a[8]*u.z),t.x+=d.x*e,t.y+=d.y*e,t.z+=d.z*e,p.integrate(this.angularVelocity,e,this.angularFactor,p),f&&(n?p.normalizeFast():p.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,f,n){function o(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis="undefined"!=typeof e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis="undefined"!=typeof e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis="undefined"!=typeof e.indexUpAxis?e.indexUpAxis:2}function d(e,f,n,o,d){var t=0,l=n,u=j,p=v,s=A;e.getVelocityAtWorldPoint(l,u),f.getVelocityAtWorldPoint(l,p),u.vsub(p,s);var y=o.dot(s),c=i(e,n,o),a=i(f,n,o),r=1,w=r/(c+a);return t=-y*w,t>d&&(t=d),-d>t&&(t=-d),t}function i(e,f,n){var o=C,d=O,i=h,t=k;return f.vsub(e.position,o),o.cross(n,d),e.invInertiaWorld.vmult(d,t),t.cross(o,i),e.invMass+n.dot(i)}function t(e,f,n,o,d,i){var t=d.norm2();if(t>1.1)return 0;var l=q,u=z,p=B;e.getVelocityAtWorldPoint(f,l),n.getVelocityAtWorldPoint(o,u),l.vsub(u,p);var s=d.dot(p),y=.2,c=1/(e.invMass+n.invMass),i=-y*s*c;return i}var l=(e("./Body"),e("../math/Vec3")),u=e("../math/Quaternion"),p=(e("../collision/RaycastResult"),e("../collision/Ray")),s=e("../objects/WheelInfo");f.exports=o;var y=(new l,new l,new l,new l),c=new l,a=new l;new p;o.prototype.addWheel=function(e){e=e||{};var f=new s(e),n=this.wheelInfos.length;return this.wheelInfos.push(f),n},o.prototype.setSteeringValue=function(e,f){var n=this.wheelInfos[f];n.steering=e};new l;o.prototype.applyEngineForce=function(e,f){this.wheelInfos[f].engineForce=e},o.prototype.setBrake=function(e,f){this.wheelInfos[f].brake=e},o.prototype.addToWorld=function(e){this.constraints;e.addBody(this.chassisBody);var f=this;this.preStepCallback=function(){f.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},o.prototype.getVehicleAxisWorld=function(e,f){f.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(f,f)},o.prototype.updateVehicle=function(e){for(var f=this.wheelInfos,n=f.length,o=this.chassisBody,d=0;n>d;d++)this.updateWheelTransform(d);this.currentVehicleSpeedKmHour=3.6*o.velocity.norm();var i=new l;this.getVehicleAxisWorld(this.indexForwardAxis,i),i.dot(o.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var d=0;n>d;d++)this.castRay(f[d]);this.updateSuspension(e);for(var t=new l,u=new l,d=0;n>d;d++){var p=f[d],s=p.suspensionForce;s>p.maxSuspensionForce&&(s=p.maxSuspensionForce),p.raycastResult.hitNormalWorld.scale(s*e,t),p.raycastResult.hitPointWorld.vsub(o.position,u),o.applyImpulse(t,u)}this.updateFriction(e);var y=new l,c=new l,a=new l;for(d=0;n>d;d++){var p=f[d];o.getVelocityAtWorldPoint(p.chassisConnectionPointWorld,a);var r=1;switch(this.indexUpAxis){case 1:r=-1}if(p.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,c);var w=c.dot(p.raycastResult.hitNormalWorld);p.raycastResult.hitNormalWorld.scale(w,y),c.vsub(y,c);var b=c.dot(a);p.deltaRotation=r*b*e/p.radius}!p.sliding&&p.isInContact||0===p.engineForce||!p.useCustomSlidingRotationalSpeed||(p.deltaRotation=(p.engineForce>0?1:-1)*p.customSlidingRotationalSpeed*e),Math.abs(p.brake)>Math.abs(p.engineForce)&&(p.deltaRotation=0),p.rotation+=p.deltaRotation,p.deltaRotation*=.99}},o.prototype.updateSuspension=function(e){for(var f=this.chassisBody,n=f.mass,o=this.wheelInfos,d=o.length,i=0;d>i;i++){var t=o[i];if(t.isInContact){var l,u=t.suspensionRestLength,p=t.suspensionLength,s=u-p;l=t.suspensionStiffness*s*t.clippedInvContactDotSuspension;var y,c=t.suspensionRelativeVelocity;y=0>c?t.dampingCompression:t.dampingRelaxation,l-=y*c,t.suspensionForce=l*n,t.suspensionForce<0&&(t.suspensionForce=0)}else t.suspensionForce=0}},o.prototype.removeFromWorld=function(e){this.constraints;e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var r=new l,w=new l;o.prototype.castRay=function(e){var f=r,n=w;this.updateWheelTransformWorld(e);var o=this.chassisBody,d=-1,i=e.suspensionRestLength+e.radius;e.directionWorld.scale(i,f);var t=e.chassisConnectionPointWorld;t.vadd(f,n);var u=e.raycastResult;u.reset();var p=o.collisionResponse;o.collisionResponse=!1,this.world.rayTest(t,n,u),o.collisionResponse=p;var s=u.body;if(e.raycastResult.groundObject=0,s){d=u.distance,e.raycastResult.hitNormalWorld=u.hitNormalWorld,e.isInContact=!0;var y=u.distance;e.suspensionLength=y-e.radius;var c=e.suspensionRestLength-e.maxSuspensionTravel,a=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<c&&(e.suspensionLength=c),e.suspensionLength>a&&(e.suspensionLength=a,e.raycastResult.reset());var b=e.raycastResult.hitNormalWorld.dot(e.directionWorld),m=new l;o.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,m);var N=e.raycastResult.hitNormalWorld.dot(m);if(b>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var g=-1/b;e.suspensionRelativeVelocity=N*g,e.clippedInvContactDotSuspension=g}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return d},o.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var f=this.chassisBody;f.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),f.vectorToWorldFrame(e.directionLocal,e.directionWorld),f.vectorToWorldFrame(e.axleLocal,e.axleWorld)},o.prototype.updateWheelTransform=function(e){var f=y,n=c,o=a,d=this.wheelInfos[e];this.updateWheelTransformWorld(d),d.directionLocal.scale(-1,f),n.copy(d.axleLocal),f.cross(n,o),o.normalize(),n.normalize();var i=d.steering,t=new u;t.setFromAxisAngle(f,i);var l=new u;l.setFromAxisAngle(n,d.rotation);var p=d.worldTransform.quaternion;this.chassisBody.quaternion.mult(t,p),p.mult(l,p),p.normalize();var s=d.worldTransform.position;s.copy(d.directionWorld),s.scale(d.suspensionLength,s),s.vadd(d.chassisConnectionPointWorld,s)};var b=[new l(1,0,0),new l(0,1,0),new l(0,0,1)];o.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var m=new l,N=[],g=[],x=1;o.prototype.updateFriction=function(e){for(var f=m,n=this.wheelInfos,o=n.length,i=this.chassisBody,u=g,p=N,s=0,y=0;o>y;y++){var c=n[y],a=c.raycastResult.body;a&&s++,c.sideImpulse=0,c.forwardImpulse=0,u[y]||(u[y]=new l),p[y]||(p[y]=new l)}for(var y=0;o>y;y++){var c=n[y],a=c.raycastResult.body;if(a){var r=p[y],w=this.getWheelTransformWorld(y);w.vectorToWorldFrame(b[this.indexRightAxis],r);var j=c.raycastResult.hitNormalWorld,v=r.dot(j);j.scale(v,f),r.vsub(f,r),r.normalize(),j.cross(r,u[y]),u[y].normalize(),c.sideImpulse=t(i,c.raycastResult.hitPointWorld,a,c.raycastResult.hitPointWorld,r),c.sideImpulse*=x}}var A=1,C=.5;this.sliding=!1;for(var y=0;o>y;y++){var c=n[y],a=c.raycastResult.body,O=0;
if(c.slipInfo=1,a){var h=0,k=c.brake?c.brake:h;O=d(i,a,c.raycastResult.hitPointWorld,u[y],k),O+=c.engineForce*e;var q=k/O;c.slipInfo*=q}if(c.forwardImpulse=0,c.skidInfo=1,a){c.skidInfo=1;var z=c.suspensionForce*e*c.frictionSlip,B=z,D=z*B;c.forwardImpulse=O;var E=c.forwardImpulse*C,F=c.sideImpulse*A,G=E*E+F*F;if(c.sliding=!1,G>D){this.sliding=!0,c.sliding=!0;var q=z/Math.sqrt(G);c.skidInfo*=q}}}if(this.sliding)for(var y=0;o>y;y++){var c=n[y];0!==c.sideImpulse&&c.skidInfo<1&&(c.forwardImpulse*=c.skidInfo,c.sideImpulse*=c.skidInfo)}for(var y=0;o>y;y++){var c=n[y],H=new l;if(c.raycastResult.hitPointWorld.vsub(i.position,H),0!==c.forwardImpulse){var I=new l;u[y].scale(c.forwardImpulse,I),i.applyImpulse(I,H)}if(0!==c.sideImpulse){var a=c.raycastResult.body,J=new l;c.raycastResult.hitPointWorld.vsub(a.position,J);var K=new l;p[y].scale(c.sideImpulse,K),i.vectorToLocalFrame(H,H),H["xyz"[this.indexUpAxis]]*=c.rollInfluence,i.vectorToWorldFrame(H,H),i.applyImpulse(K,H),K.scale(-1,K),a.applyImpulse(K,J)}}};var j=new l,v=new l,A=new l,C=new l,O=new l,h=new l,k=new l,q=new l,z=new l,B=new l},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,f,n){function o(e){if(this.wheelBodies=[],this.coordinateSystem="undefined"==typeof e.coordinateSystem?new l(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var f=new t(new l(5,2,.5));this.chassisBody=new d(1,f)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var d=e("./Body"),i=e("../shapes/Sphere"),t=e("../shapes/Box"),l=e("../math/Vec3"),u=e("../constraints/HingeConstraint");f.exports=o,o.prototype.addWheel=function(e){e=e||{};var f=e.body;f||(f=new d(1,new i(1.2))),this.wheelBodies.push(f),this.wheelForces.push(0);var n=(new l,"undefined"!=typeof e.position?e.position.clone():new l),o=new l;this.chassisBody.pointToWorldFrame(n,o),f.position.set(o.x,o.y,o.z);var t="undefined"!=typeof e.axis?e.axis.clone():new l(0,1,0);this.wheelAxes.push(t);var p=new u(this.chassisBody,f,{pivotA:n,axisA:t,pivotB:l.ZERO,axisB:t,collideConnected:!1});return this.constraints.push(p),this.wheelBodies.length-1},o.prototype.setSteeringValue=function(e,f){var n=this.wheelAxes[f],o=Math.cos(e),d=Math.sin(e),i=n.x,t=n.y;this.constraints[f].axisA.set(o*i-d*t,d*i+o*t,0)},o.prototype.setMotorSpeed=function(e,f){var n=this.constraints[f];n.enableMotor(),n.motorTargetVelocity=e},o.prototype.disableMotor=function(e){var f=this.constraints[e];f.disableMotor()};var p=new l;o.prototype.setWheelForce=function(e,f){this.wheelForces[f]=e},o.prototype.applyWheelForce=function(e,f){var n=this.wheelAxes[f],o=this.wheelBodies[f],d=o.torque;n.scale(e,p),o.vectorToWorldFrame(p,p),d.vadd(p,d)},o.prototype.addToWorld=function(e){for(var f=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),o=0;o<n.length;o++)e.addBody(n[o]);for(var o=0;o<f.length;o++)e.addConstraint(f[o]);e.addEventListener("preStep",this._update.bind(this))},o.prototype._update=function(){for(var e=this.wheelForces,f=0;f<e.length;f++)this.applyWheelForce(e[f],f)},o.prototype.removeFromWorld=function(e){for(var f=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),o=0;o<n.length;o++)e.remove(n[o]);for(var o=0;o<f.length;o++)e.removeConstraint(f[o])};var s=new l;o.prototype.getWheelSpeed=function(e){var f=this.wheelAxes[e],n=this.wheelBodies[e],o=n.angularVelocity;return this.chassisBody.vectorToWorldFrame(f,s),o.dot(s)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,f,n){function o(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}f.exports=o;var d=(e("../shapes/Shape"),e("../math/Vec3"));e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material");o.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},o.prototype.remove=function(e){var f=this.particles.indexOf(e);-1!==f&&(this.particles.splice(f,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var i=new d;o.prototype.getNeighbors=function(e,f){for(var n=this.particles.length,o=e.id,d=this.smoothingRadius*this.smoothingRadius,t=i,l=0;l!==n;l++){var u=this.particles[l];u.position.vsub(e.position,t),o!==u.id&&t.norm2()<d&&f.push(u)}};var t=new d,l=new d,u=new d,p=new d,s=new d,y=new d;o.prototype.update=function(){for(var e=this.particles.length,f=t,n=this.speedOfSound,o=this.eps,d=0;d!==e;d++){var i=this.particles[d],c=this.neighbors[d];c.length=0,this.getNeighbors(i,c),c.push(this.particles[d]);for(var a=c.length,r=0,w=0;w!==a;w++){i.position.vsub(c[w].position,f);var b=f.norm(),m=this.w(b);r+=c[w].mass*m}this.densities[d]=r,this.pressures[d]=n*n*(this.densities[d]-this.density)}for(var N=l,g=u,x=p,j=s,v=y,d=0;d!==e;d++){var A=this.particles[d];N.set(0,0,0),g.set(0,0,0);for(var C,O,c=this.neighbors[d],a=c.length,w=0;w!==a;w++){var h=c[w];A.position.vsub(h.position,j);var k=j.norm();C=-h.mass*(this.pressures[d]/(this.densities[d]*this.densities[d]+o)+this.pressures[w]/(this.densities[w]*this.densities[w]+o)),this.gradw(j,x),x.mult(C,x),N.vadd(x,N),h.velocity.vsub(A.velocity,v),v.mult(1/(1e-4+this.densities[d]*this.densities[w])*this.viscosity*h.mass,v),O=this.nablaw(k),v.mult(O,v),g.vadd(v,g)}g.mult(A.mass,g),N.mult(A.mass,N),A.force.vadd(g,A.force),A.force.vadd(N,A.force)}},o.prototype.w=function(e){var f=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(f,9))*Math.pow(f*f-e*e,3)},o.prototype.gradw=function(e,f){var n=e.norm(),o=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(o,9))*Math.pow(o*o-n*n,2),f)},o.prototype.nablaw=function(e){var f=this.smoothingRadius,n=945/(32*Math.PI*Math.pow(f,9))*(f*f-e*e)*(7*e*e-3*f*f);return n}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,f,n){function o(e,f,n){n=n||{},this.restLength="number"==typeof n.restLength?n.restLength:1,this.stiffness=n.stiffness||100,this.damping=n.damping||1,this.bodyA=e,this.bodyB=f,this.localAnchorA=new d,this.localAnchorB=new d,n.localAnchorA&&this.localAnchorA.copy(n.localAnchorA),n.localAnchorB&&this.localAnchorB.copy(n.localAnchorB),n.worldAnchorA&&this.setWorldAnchorA(n.worldAnchorA),n.worldAnchorB&&this.setWorldAnchorB(n.worldAnchorB)}var d=e("../math/Vec3");f.exports=o,o.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},o.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},o.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},o.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var i=new d,t=new d,l=new d,u=new d,p=new d,s=new d,y=new d,c=new d,a=new d,r=new d,w=new d;o.prototype.applyForce=function(){var e=this.stiffness,f=this.damping,n=this.restLength,o=this.bodyA,d=this.bodyB,b=i,m=t,N=l,g=u,x=w,j=p,v=s,A=y,C=c,O=a,h=r;this.getWorldAnchorA(j),this.getWorldAnchorB(v),j.vsub(o.position,A),v.vsub(d.position,C),v.vsub(j,b);var k=b.norm();m.copy(b),m.normalize(),d.velocity.vsub(o.velocity,N),d.angularVelocity.cross(C,x),N.vadd(x,N),o.angularVelocity.cross(A,x),N.vsub(x,N),m.mult(-e*(k-n)-f*N.dot(m),g),o.force.vsub(g,o.force),d.force.vadd(g,d.force),A.cross(g,O),C.cross(g,h),o.torque.vsub(O,o.torque),d.torque.vadd(h,d.torque)}},{"../math/Vec3":30}],36:[function(e,f,n){function o(e){e=l.defaults(e,{chassisConnectionPointLocal:new d,chassisConnectionPointWorld:new d,directionLocal:new d,directionWorld:new d,axleLocal:new d,axleWorld:new d,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new t,this.worldTransform=new i,this.isInContact=!1}var d=e("../math/Vec3"),i=e("../math/Transform"),t=e("../collision/RaycastResult"),l=e("../utils/Utils");f.exports=o;var u=new d,p=new d,u=new d;o.prototype.updateWheel=function(e){var f=this.raycastResult;if(this.isInContact){var n=f.hitNormalWorld.dot(f.directionWorld);f.hitPointWorld.vsub(e.position,p),e.getVelocityAtWorldPoint(p,u);var o=f.hitNormalWorld.dot(u);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var d=-1/n;this.suspensionRelativeVelocity=o*d,this.clippedInvContactDotSuspension=d}}else f.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,f.directionWorld.scale(-1,f.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,f,n){function o(e){d.call(this),this.type=d.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}f.exports=o;var d=e("./Shape"),i=e("../math/Vec3"),t=e("./ConvexPolyhedron");o.prototype=new d,o.prototype.constructor=o,o.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,f=this.halfExtents.y,n=this.halfExtents.z,o=i,d=[new o(-e,-f,-n),new o(e,-f,-n),new o(e,f,-n),new o(-e,f,-n),new o(-e,-f,n),new o(e,-f,n),new o(e,f,n),new o(-e,f,n)],l=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],u=([new o(0,0,1),new o(0,1,0),new o(1,0,0)],new t(d,l));this.convexPolyhedronRepresentation=u,u.material=this.material},o.prototype.calculateLocalInertia=function(e,f){return f=f||new i,o.calculateInertia(this.halfExtents,e,f),f},o.calculateInertia=function(e,f,n){var o=e;n.x=1/12*f*(2*o.y*2*o.y+2*o.z*2*o.z),n.y=1/12*f*(2*o.x*2*o.x+2*o.z*2*o.z),n.z=1/12*f*(2*o.y*2*o.y+2*o.x*2*o.x)},o.prototype.getSideNormals=function(e,f){var n=e,o=this.halfExtents;if(n[0].set(o.x,0,0),n[1].set(0,o.y,0),n[2].set(0,0,o.z),n[3].set(-o.x,0,0),n[4].set(0,-o.y,0),n[5].set(0,0,-o.z),void 0!==f)for(var d=0;d!==n.length;d++)f.vmult(n[d],n[d]);return n},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new i;new i;o.prototype.forEachWorldCorner=function(e,f,n){for(var o=this.halfExtents,d=[[o.x,o.y,o.z],[-o.x,o.y,o.z],[-o.x,-o.y,o.z],[-o.x,-o.y,-o.z],[o.x,-o.y,-o.z],[o.x,o.y,-o.z],[-o.x,o.y,-o.z],[o.x,-o.y,o.z]],i=0;i<d.length;i++)l.set(d[i][0],d[i][1],d[i][2]),f.vmult(l,l),e.vadd(l,l),n(l.x,l.y,l.z)};var u=[new i,new i,new i,new i,new i,new i,new i,new i];o.prototype.calculateWorldAABB=function(e,f,n,o){var d=this.halfExtents;u[0].set(d.x,d.y,d.z),u[1].set(-d.x,d.y,d.z),u[2].set(-d.x,-d.y,d.z),u[3].set(-d.x,-d.y,-d.z),u[4].set(d.x,-d.y,-d.z),u[5].set(d.x,d.y,-d.z),u[6].set(-d.x,d.y,-d.z),u[7].set(d.x,-d.y,d.z);var i=u[0];f.vmult(i,i),e.vadd(i,i),o.copy(i),n.copy(i);for(var t=1;8>t;t++){var i=u[t];f.vmult(i,i),e.vadd(i,i);var l=i.x,p=i.y,s=i.z;l>o.x&&(o.x=l),p>o.y&&(o.y=p),s>o.z&&(o.z=s),l<n.x&&(n.x=l),p<n.y&&(n.y=p),s<n.z&&(n.z=s)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,f,n){function o(e,f,n){d.call(this),this.type=d.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=f||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=n?n.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}f.exports=o;var d=e("./Shape"),i=e("../math/Vec3"),t=(e("../math/Quaternion"),e("../math/Transform"));o.prototype=new d,o.prototype.constructor=o;var l=new i;o.prototype.computeEdges=function(){var e=this.faces,f=this.vertices,n=(f.length,this.uniqueEdges);n.length=0;for(var o=l,d=0;d!==e.length;d++)for(var i=e[d],t=i.length,u=0;u!==t;u++){var p=(u+1)%t;f[i[u]].vsub(f[i[p]],o),o.normalize();for(var s=!1,y=0;y!==n.length;y++)if(n[y].almostEquals(o)||n[y].almostEquals(o)){s=!0;break}s||n.push(o.clone())}},o.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var f=0;f<this.faces[e].length;f++)if(!this.vertices[this.faces[e][f]])throw new Error("Vertex "+this.faces[e][f]+" not found!");var n=this.faceNormals[e]||new i;this.getFaceNormal(e,n),n.negate(n),this.faceNormals[e]=n;var o=this.vertices[this.faces[e][0]];if(n.dot(o)<0){console.error(".faceNormals["+e+"] = Vec3("+n.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var f=0;f<this.faces[e].length;f++)console.warn(".vertices["+this.faces[e][f]+"] = Vec3("+this.vertices[this.faces[e][f]].toString()+")")}}};var u=new i,p=new i;o.computeNormal=function(e,f,n,o){f.vsub(e,p),n.vsub(f,u),u.cross(p,o),o.isZero()||o.normalize()},o.prototype.getFaceNormal=function(e,f){var n=this.faces[e],d=this.vertices[n[0]],i=this.vertices[n[1]],t=this.vertices[n[2]];return o.computeNormal(d,i,t,f)};var s=new i;o.prototype.clipAgainstHull=function(e,f,n,o,d,t,l,u,p){for(var y=s,c=-1,a=-Number.MAX_VALUE,r=0;r<n.faces.length;r++){y.copy(n.faceNormals[r]),d.vmult(y,y);var w=y.dot(t);w>a&&(a=w,c=r)}for(var b=[],m=n.faces[c],N=m.length,g=0;N>g;g++){var x=n.vertices[m[g]],j=new i;j.copy(x),d.vmult(j,j),o.vadd(j,j),b.push(j)}c>=0&&this.clipFaceAgainstHull(t,e,f,b,l,u,p)};var y=new i,c=new i,a=new i,r=new i,w=new i,b=new i;o.prototype.findSeparatingAxis=function(e,f,n,o,d,i,t,l){var u=y,p=c,s=a,m=r,N=w,g=b,x=Number.MAX_VALUE,j=this,v=0;if(j.uniqueAxes)for(var A=0;A!==j.uniqueAxes.length;A++){n.vmult(j.uniqueAxes[A],u);var C=j.testSepAxis(u,e,f,n,o,d);if(C===!1)return!1;x>C&&(x=C,i.copy(u))}else for(var O=t?t.length:j.faces.length,A=0;O>A;A++){var h=t?t[A]:A;u.copy(j.faceNormals[h]),n.vmult(u,u);var C=j.testSepAxis(u,e,f,n,o,d);if(C===!1)return!1;x>C&&(x=C,i.copy(u))}if(e.uniqueAxes)for(var A=0;A!==e.uniqueAxes.length;A++){d.vmult(e.uniqueAxes[A],p),v++;var C=j.testSepAxis(p,e,f,n,o,d);if(C===!1)return!1;x>C&&(x=C,i.copy(p))}else for(var k=l?l.length:e.faces.length,A=0;k>A;A++){var h=l?l[A]:A;p.copy(e.faceNormals[h]),d.vmult(p,p),v++;var C=j.testSepAxis(p,e,f,n,o,d);if(C===!1)return!1;x>C&&(x=C,i.copy(p))}for(var q=0;q!==j.uniqueEdges.length;q++){n.vmult(j.uniqueEdges[q],m);for(var z=0;z!==e.uniqueEdges.length;z++)if(d.vmult(e.uniqueEdges[z],N),m.cross(N,g),!g.almostZero()){g.normalize();var B=j.testSepAxis(g,e,f,n,o,d);if(B===!1)return!1;x>B&&(x=B,i.copy(g))}}return o.vsub(f,s),s.dot(i)>0&&i.negate(i),!0};var m=[],N=[];o.prototype.testSepAxis=function(e,f,n,d,i,t){var l=this;o.project(l,e,n,d,m),o.project(f,e,i,t,N);var u=m[0],p=m[1],s=N[0],y=N[1];if(y>u||p>s)return!1;var c=u-y,a=s-p,r=a>c?c:a;return r};var g=new i,x=new i;o.prototype.calculateLocalInertia=function(e,f){this.computeLocalAABB(g,x);var n=x.x-g.x,o=x.y-g.y,d=x.z-g.z;f.x=1/12*e*(2*o*2*o+2*d*2*d),f.y=1/12*e*(2*n*2*n+2*d*2*d),f.z=1/12*e*(2*o*2*o+2*n*2*n)},o.prototype.getPlaneConstantOfFace=function(e){var f=this.faces[e],n=this.faceNormals[e],o=this.vertices[f[0]],d=-n.dot(o);return d};var j=new i,v=new i,A=new i,C=new i,O=new i,h=new i,k=new i,q=new i;o.prototype.clipFaceAgainstHull=function(e,f,n,o,d,i,t){for(var l=j,u=v,p=A,s=C,y=O,c=h,a=k,r=q,w=this,b=[],m=o,N=b,g=-1,x=Number.MAX_VALUE,z=0;z<w.faces.length;z++){l.copy(w.faceNormals[z]),n.vmult(l,l);var B=l.dot(e);x>B&&(x=B,g=z)}if(!(0>g)){var D=w.faces[g];D.connectedFaces=[];for(var E=0;E<w.faces.length;E++)for(var F=0;F<w.faces[E].length;F++)-1!==D.indexOf(w.faces[E][F])&&E!==g&&-1===D.connectedFaces.indexOf(E)&&D.connectedFaces.push(E);for(var G=(m.length,D.length),H=0;G>H;H++){var I=w.vertices[D[H]],J=w.vertices[D[(H+1)%G]];I.vsub(J,u),p.copy(u),n.vmult(p,p),f.vadd(p,p),s.copy(this.faceNormals[g]),n.vmult(s,s),f.vadd(s,s),p.cross(s,y),y.negate(y),c.copy(I),n.vmult(c,c),f.vadd(c,c);var K,L=(-c.dot(y),D.connectedFaces[H]);a.copy(this.faceNormals[L]);var M=this.getPlaneConstantOfFace(L);r.copy(a),n.vmult(r,r);var K=M-r.dot(f);for(this.clipFaceAgainstPlane(m,N,r,K);m.length;)m.shift();for(;N.length;)m.push(N.shift())}a.copy(this.faceNormals[g]);var M=this.getPlaneConstantOfFace(g);r.copy(a),n.vmult(r,r);for(var K=M-r.dot(f),E=0;E<m.length;E++){var P=r.dot(m[E])+K;if(d>=P&&(console.log("clamped: depth="+P+" to minDist="+(d+"")),P=d),i>=P){var Q=m[E];if(0>=P){var R={point:Q,normal:r,depth:P};t.push(R)}}}}},o.prototype.clipFaceAgainstPlane=function(e,f,n,o){var d,t,l=e.length;if(2>l)return f;var u=e[e.length-1],p=e[0];d=n.dot(u)+o;for(var s=0;l>s;s++){if(p=e[s],t=n.dot(p)+o,0>d)if(0>t){var y=new i;y.copy(p),f.push(y)}else{var y=new i;u.lerp(p,d/(d-t),y),f.push(y)}else if(0>t){var y=new i;u.lerp(p,d/(d-t),y),f.push(y),f.push(p)}u=p,d=t}return f},o.prototype.computeWorldVertices=function(e,f){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new i);for(var o=this.vertices,d=this.worldVertices,t=0;t!==n;t++)f.vmult(o[t],d[t]),e.vadd(d[t],d[t]);this.worldVerticesNeedsUpdate=!1};new i;o.prototype.computeLocalAABB=function(e,f){var n=this.vertices.length,o=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),f.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var d=0;n>d;d++){var i=o[d];i.x<e.x?e.x=i.x:i.x>f.x&&(f.x=i.x),i.y<e.y?e.y=i.y:i.y>f.y&&(f.y=i.y),i.z<e.z?e.z=i.z:i.z>f.z&&(f.z=i.z)}},o.prototype.computeWorldFaceNormals=function(e){for(var f=this.faceNormals.length;this.worldFaceNormals.length<f;)this.worldFaceNormals.push(new i);for(var n=this.faceNormals,o=this.worldFaceNormals,d=0;d!==f;d++)e.vmult(n[d],o[d]);this.worldFaceNormalsNeedsUpdate=!1},o.prototype.updateBoundingSphereRadius=function(){for(var e=0,f=this.vertices,n=0,o=f.length;n!==o;n++){var d=f[n].norm2();d>e&&(e=d)}this.boundingSphereRadius=Math.sqrt(e)};var z=new i;o.prototype.calculateWorldAABB=function(e,f,n,o){for(var d,i,t,l,u,p,s=this.vertices.length,y=this.vertices,c=0;s>c;c++){z.copy(y[c]),f.vmult(z,z),e.vadd(z,z);var a=z;a.x<d||void 0===d?d=a.x:(a.x>l||void 0===l)&&(l=a.x),a.y<i||void 0===i?i=a.y:(a.y>u||void 0===u)&&(u=a.y),a.z<t||void 0===t?t=a.z:(a.z>p||void 0===p)&&(p=a.z)}n.set(d,i,t),o.set(l,u,p)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.prototype.getAveragePointLocal=function(e){e=e||new i;for(var f=this.vertices.length,n=this.vertices,o=0;f>o;o++)e.vadd(n[o],e);return e.mult(1/f,e),e},o.prototype.transformAllPoints=function(e,f){var n=this.vertices.length,o=this.vertices;if(f){for(var d=0;n>d;d++){var i=o[d];f.vmult(i,i)}for(var d=0;d<this.faceNormals.length;d++){var i=this.faceNormals[d];f.vmult(i,i)}}if(e)for(var d=0;n>d;d++){var i=o[d];i.vadd(e,i)}};var B=new i,D=new i,E=new i;o.prototype.pointIsInside=function(e){var f=this.vertices.length,n=this.vertices,o=this.faces,d=this.faceNormals,i=null,t=this.faces.length,l=B;this.getAveragePointLocal(l);for(var u=0;t>u;u++){var f=(this.faces[u].length,d[u]),p=n[o[u][0]],s=D;e.vsub(p,s);var y=f.dot(s),c=E;l.vsub(p,c);var a=f.dot(c);if(0>y&&a>0||y>0&&0>a)return!1}return i?1:-1};var F=(new i,new i),G=new i;o.project=function(e,f,n,o,d){var i=e.vertices.length,l=F,u=0,p=0,s=G,y=e.vertices;s.setZero(),t.vectorToLocalFrame(n,o,f,l),t.pointToLocalFrame(n,o,s,s);var c=s.dot(l);p=u=y[0].dot(l);for(var a=1;i>a;a++){var r=y[a].dot(l);r>u&&(u=r),p>r&&(p=r)}if(p-=c,u-=c,p>u){var w=p;p=u,u=w}d[0]=u,d[1]=p}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,f,n){function o(e,f,n,o){var l=o,u=[],p=[],s=[],y=[],c=[],a=Math.cos,r=Math.sin;u.push(new i(f*a(0),f*r(0),.5*-n)),y.push(0),u.push(new i(e*a(0),e*r(0),.5*n)),c.push(1);for(var w=0;l>w;w++){var b=2*Math.PI/l*(w+1),m=2*Math.PI/l*(w+.5);l-1>w?(u.push(new i(f*a(b),f*r(b),.5*-n)),y.push(2*w+2),u.push(new i(e*a(b),e*r(b),.5*n)),c.push(2*w+3),s.push([2*w+2,2*w+3,2*w+1,2*w])):s.push([0,1,2*w+1,2*w]),(l%2===1||l/2>w)&&p.push(new i(a(m),r(m),0))}s.push(c),p.push(new i(0,0,1));for(var N=[],w=0;w<y.length;w++)N.push(y[y.length-w-1]);s.push(N),this.type=d.types.CONVEXPOLYHEDRON,t.call(this,u,s,p)}f.exports=o;var d=e("./Shape"),i=e("../math/Vec3"),t=(e("../math/Quaternion"),e("./ConvexPolyhedron"));o.prototype=new t},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,f,n){function o(e,f){f=l.defaults(f,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=f.maxValue,this.minValue=f.minValue,this.elementSize=f.elementSize,null===f.minValue&&this.updateMinValue(),null===f.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,d.call(this),this.pillarConvex=new i,this.pillarOffset=new t,this.type=d.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var d=e("./Shape"),i=e("./ConvexPolyhedron"),t=e("../math/Vec3"),l=e("../utils/Utils");f.exports=o,o.prototype=new d,o.prototype.update=function(){this._cachedPillars={}},o.prototype.updateMinValue=function(){for(var e=this.data,f=e[0][0],n=0;n!==e.length;n++)for(var o=0;o!==e[n].length;o++){var d=e[n][o];f>d&&(f=d)}this.minValue=f},o.prototype.updateMaxValue=function(){for(var e=this.data,f=e[0][0],n=0;n!==e.length;n++)for(var o=0;o!==e[n].length;o++){var d=e[n][o];d>f&&(f=d)}this.maxValue=f},o.prototype.setHeightValueAtIndex=function(e,f,n){var o=this.data;o[e][f]=n,this.clearCachedConvexTrianglePillar(e,f,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,f,!0),this.clearCachedConvexTrianglePillar(e-1,f,!1)),f>0&&(this.clearCachedConvexTrianglePillar(e,f-1,!0),this.clearCachedConvexTrianglePillar(e,f-1,!1)),f>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,f-1,!0)},o.prototype.getRectMinMax=function(e,f,n,o,d){d=d||[];for(var i=this.data,t=this.minValue,l=e;n>=l;l++)for(var u=f;o>=u;u++){var p=i[l][u];p>t&&(t=p)}d[0]=this.minValue,d[1]=t},o.prototype.getIndexOfPosition=function(e,f,n,o){var d=this.elementSize,i=this.data,t=Math.floor(e/d),l=Math.floor(f/d);return n[0]=t,n[1]=l,o&&(0>t&&(t=0),0>l&&(l=0),t>=i.length-1&&(t=i.length-1),l>=i[0].length-1&&(l=i[0].length-1)),0>t||0>l||t>=i.length-1||l>=i[0].length-1?!1:!0},o.prototype.getHeightAt=function(e,f,n){var o=[];this.getIndexOfPosition(e,f,o,n);var d=[];return this.getRectMinMax(o[0],o[1]+1,o[0],o[1]+1,d),(d[0]+d[1])/2},o.prototype.getCacheConvexTrianglePillarKey=function(e,f,n){return e+"_"+f+"_"+(n?1:0)},o.prototype.getCachedConvexTrianglePillar=function(e,f,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,f,n)]},o.prototype.setCachedConvexTrianglePillar=function(e,f,n,o,d){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,f,n)]={convex:o,offset:d}},o.prototype.clearCachedConvexTrianglePillar=function(e,f,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,f,n)]},o.prototype.getConvexTrianglePillar=function(e,f,n){var o=this.pillarConvex,d=this.pillarOffset;if(this.cacheEnabled){var l=this.getCachedConvexTrianglePillar(e,f,n);if(l)return this.pillarConvex=l.convex,void(this.pillarOffset=l.offset);o=new i,d=new t,this.pillarConvex=o,this.pillarOffset=d}var l=this.data,u=this.elementSize,p=o.faces;o.vertices.length=6;for(var s=0;6>s;s++)o.vertices[s]||(o.vertices[s]=new t);p.length=5;for(var s=0;5>s;s++)p[s]||(p[s]=[]);var y=o.vertices,c=(Math.min(l[e][f],l[e+1][f],l[e][f+1],l[e+1][f+1])-this.minValue)/2+this.minValue;n?(d.set((e+.75)*u,(f+.75)*u,c),y[0].set(.25*u,.25*u,l[e+1][f+1]-c),y[1].set(-.75*u,.25*u,l[e][f+1]-c),y[2].set(.25*u,-.75*u,l[e+1][f]-c),y[3].set(.25*u,.25*u,-c-1),y[4].set(-.75*u,.25*u,-c-1),y[5].set(.25*u,-.75*u,-c-1),p[0][0]=0,p[0][1]=1,p[0][2]=2,p[1][0]=5,p[1][1]=4,p[1][2]=3,p[2][0]=2,p[2][1]=5,p[2][2]=3,p[2][3]=0,p[3][0]=3,p[3][1]=4,p[3][2]=1,p[3][3]=0,p[4][0]=1,p[4][1]=4,p[4][2]=5,p[4][3]=2):(d.set((e+.25)*u,(f+.25)*u,c),y[0].set(-.25*u,-.25*u,l[e][f]-c),y[1].set(.75*u,-.25*u,l[e+1][f]-c),y[2].set(-.25*u,.75*u,l[e][f+1]-c),y[3].set(-.25*u,-.25*u,-c-1),y[4].set(.75*u,-.25*u,-c-1),y[5].set(-.25*u,.75*u,-c-1),p[0][0]=0,p[0][1]=1,p[0][2]=2,p[1][0]=5,p[1][1]=4,p[1][2]=3,p[2][0]=0,p[2][1]=2,p[2][2]=5,p[2][3]=3,p[3][0]=1,p[3][1]=0,p[3][2]=3,p[3][3]=4,p[4][0]=4,p[4][1]=5,p[4][2]=2,p[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,f,n,o,d)},o.prototype.calculateLocalInertia=function(e,f){return f=f||new t,f.set(0,0,0),f},o.prototype.volume=function(){return Number.MAX_VALUE},o.prototype.calculateWorldAABB=function(e,f,n,o){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},o.prototype.updateBoundingSphereRadius=function(){var e=this.data,f=this.elementSize;this.boundingSphereRadius=new t(e.length*f,e[0].length*f,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,f,n){function o(){d.call(this),this.type=d.types.PARTICLE}f.exports=o;var d=e("./Shape"),i=e("../math/Vec3");o.prototype=new d,o.prototype.constructor=o,o.prototype.calculateLocalInertia=function(e,f){return f=f||new i,f.set(0,0,0),f},o.prototype.volume=function(){return 0},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},o.prototype.calculateWorldAABB=function(e,f,n,o){n.copy(e),o.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,f,n){function o(){d.call(this),this.type=d.types.PLANE,this.worldNormal=new i,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}f.exports=o;var d=e("./Shape"),i=e("../math/Vec3");o.prototype=new d,o.prototype.constructor=o,o.prototype.computeWorldNormal=function(e){var f=this.worldNormal;f.set(0,0,1),e.vmult(f,f),this.worldNormalNeedsUpdate=!1},o.prototype.calculateLocalInertia=function(e,f){return f=f||new i},o.prototype.volume=function(){return Number.MAX_VALUE};var t=new i;o.prototype.calculateWorldAABB=function(e,f,n,o){t.set(0,0,1),f.vmult(t,t);var d=Number.MAX_VALUE;n.set(-d,-d,-d),o.set(d,d,d),1===t.x&&(o.x=e.x),1===t.y&&(o.y=e.y),1===t.z&&(o.z=e.z),-1===t.x&&(n.x=e.x),-1===t.y&&(n.y=e.y),-1===t.z&&(n.z=e.z)},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,f,n){function o(){this.id=o.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}f.exports=o;var o=e("./Shape");e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material");o.prototype.constructor=o,o.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},o.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},o.prototype.calculateLocalInertia=function(e,f){throw"calculateLocalInertia() not implemented for shape type "+this.type},o.idCounter=0,o.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,f,n){function o(e){if(d.call(this),this.radius=void 0!==e?Number(e):1,this.type=d.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}f.exports=o;var d=e("./Shape"),i=e("../math/Vec3");o.prototype=new d,o.prototype.constructor=o,o.prototype.calculateLocalInertia=function(e,f){f=f||new i;var n=2*e*this.radius*this.radius/5;return f.x=n,f.y=n,f.z=n,f},o.prototype.volume=function(){return 4*Math.PI*this.radius/3},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},o.prototype.calculateWorldAABB=function(e,f,n,o){for(var d=this.radius,i=["x","y","z"],t=0;t<i.length;t++){var l=i[t];n[l]=e[l]-d,o[l]=e[l]+d}}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,f,n){function o(e,f){d.call(this),this.type=d.types.TRIMESH,this.vertices=new Float32Array(e),this.indices=new Int16Array(f),this.normals=new Float32Array(f.length),this.aabb=new l,this.edges=null,this.scale=new i(1,1,1),this.tree=new u,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}f.exports=o;var d=e("./Shape"),i=e("../math/Vec3"),t=(e("../math/Quaternion"),e("../math/Transform")),l=e("../collision/AABB"),u=e("../utils/Octree");o.prototype=new d,o.prototype.constructor=o;var p=new i;o.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var f=this.scale;e.aabb.lowerBound.x*=1/f.x,e.aabb.lowerBound.y*=1/f.y,e.aabb.lowerBound.z*=1/f.z,e.aabb.upperBound.x*=1/f.x,e.aabb.upperBound.y*=1/f.y,e.aabb.upperBound.z*=1/f.z;for(var n=new l,o=new i,d=new i,t=new i,u=[o,d,t],p=0;p<this.indices.length/3;p++){var s=3*p;this._getUnscaledVertex(this.indices[s],o),this._getUnscaledVertex(this.indices[s+1],d),this._getUnscaledVertex(this.indices[s+2],t),n.setFromPoints(u),e.insert(n,p)}e.removeEmptyNodes()};var s=new l;o.prototype.getTrianglesInAABB=function(e,f){s.copy(e);var n=this.scale,o=n.x,d=n.y,i=n.z,t=s.lowerBound,l=s.upperBound;return t.x/=o,t.y/=d,t.z/=i,l.x/=o,l.y/=d,l.z/=i,this.tree.aabbQuery(s,f)},o.prototype.setScale=function(e){var f=this.scale.x===this.scale.y===this.scale.z,n=e.x===e.y===e.z;f&&n||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},o.prototype.updateNormals=function(){for(var e=p,f=this.normals,n=0;n<this.indices.length/3;n++){var d=3*n,i=this.indices[d],t=this.indices[d+1],l=this.indices[d+2];this.getVertex(i,w),this.getVertex(t,b),this.getVertex(l,m),o.computeNormal(b,w,m,e),f[d]=e.x,f[d+1]=e.y,f[d+2]=e.z}},o.prototype.updateEdges=function(){for(var e={},f=function(f,n){var o=i>d?d+"_"+i:i+"_"+d;e[o]=!0},n=0;n<this.indices.length/3;n++){var o=3*n,d=this.indices[o],i=this.indices[o+1],t=this.indices[o+2];f(d,i),f(i,t),f(t,d)}var l=Object.keys(e);this.edges=new Int16Array(2*l.length);for(var n=0;n<l.length;n++){var u=l[n].split("_");this.edges[2*n]=parseInt(u[0],10),this.edges[2*n+1]=parseInt(u[1],10)}},o.prototype.getEdgeVertex=function(e,f,n){var o=this.edges[2*e+(f?1:0)];this.getVertex(o,n)};var y=new i,c=new i;o.prototype.getEdgeVector=function(e,f){var n=y,o=c;this.getEdgeVertex(e,0,n),this.getEdgeVertex(e,1,o),o.vsub(n,f)};var a=new i,r=new i;o.computeNormal=function(e,f,n,o){f.vsub(e,r),n.vsub(f,a),a.cross(r,o),o.isZero()||o.normalize()};var w=new i,b=new i,m=new i;o.prototype.getVertex=function(e,f){var n=this.scale;return this._getUnscaledVertex(e,f),f.x*=n.x,f.y*=n.y,f.z*=n.z,f},o.prototype._getUnscaledVertex=function(e,f){
var n=3*e,o=this.vertices;return f.set(o[n],o[n+1],o[n+2])},o.prototype.getWorldVertex=function(e,f,n,o){return this.getVertex(e,o),t.pointToWorldFrame(f,n,o,o),o},o.prototype.getTriangleVertices=function(e,f,n,o){var d=3*e;this.getVertex(this.indices[d],f),this.getVertex(this.indices[d+1],n),this.getVertex(this.indices[d+2],o)},o.prototype.getNormal=function(e,f){var n=3*e;return f.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var N=new l;o.prototype.calculateLocalInertia=function(e,f){this.computeLocalAABB(N);var n=N.upperBound.x-N.lowerBound.x,o=N.upperBound.y-N.lowerBound.y,d=N.upperBound.z-N.lowerBound.z;return f.set(1/12*e*(2*o*2*o+2*d*2*d),1/12*e*(2*n*2*n+2*d*2*d),1/12*e*(2*o*2*o+2*n*2*n))};var g=new i;o.prototype.computeLocalAABB=function(e){var f=e.lowerBound,n=e.upperBound,o=this.vertices.length,d=(this.vertices,g);this.getVertex(0,d),f.copy(d),n.copy(d);for(var i=0;i!==o;i++)this.getVertex(i,d),d.x<f.x?f.x=d.x:d.x>n.x&&(n.x=d.x),d.y<f.y?f.y=d.y:d.y>n.y&&(n.y=d.y),d.z<f.z?f.z=d.z:d.z>n.z&&(n.z=d.z)},o.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},o.prototype.updateBoundingSphereRadius=function(){for(var e=0,f=this.vertices,n=new i,o=0,d=f.length/3;o!==d;o++){this.getVertex(o,n);var t=n.norm2();t>e&&(e=t)}this.boundingSphereRadius=Math.sqrt(e)};var x=(new i,new t),j=new l;o.prototype.calculateWorldAABB=function(e,f,n,o){var d=x,i=j;d.position=e,d.quaternion=f,this.aabb.toWorldFrame(d,i),n.copy(i.lowerBound),o.copy(i.upperBound)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.createTorus=function(e,f,n,d,i){e=e||1,f=f||.5,n=n||8,d=d||6,i=i||2*Math.PI;for(var t=[],l=[],u=0;n>=u;u++)for(var p=0;d>=p;p++){var s=p/d*i,y=u/n*Math.PI*2,c=(e+f*Math.cos(y))*Math.cos(s),a=(e+f*Math.cos(y))*Math.sin(s),r=f*Math.sin(y);t.push(c,a,r)}for(var u=1;n>=u;u++)for(var p=1;d>=p;p++){var w=(d+1)*u+p-1,b=(d+1)*(u-1)+p-1,m=(d+1)*(u-1)+p,N=(d+1)*u+p;l.push(w,b,N),l.push(b,m,N)}return new o(t,l)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,f,n){function o(){d.call(this),this.iterations=10,this.tolerance=1e-7}f.exports=o;var d=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver"));o.prototype=new d;var i=[],t=[],l=[];o.prototype.solve=function(e,f){var n,o,d,u,p,s,y=0,c=this.iterations,a=this.tolerance*this.tolerance,r=this.equations,w=r.length,b=f.bodies,m=b.length,N=e;if(0!==w)for(var g=0;g!==m;g++)b[g].updateSolveMassProperties();var x=t,j=l,v=i;x.length=w,j.length=w,v.length=w;for(var g=0;g!==w;g++){var A=r[g];v[g]=0,j[g]=A.computeB(N),x[g]=1/A.computeC()}if(0!==w){for(var g=0;g!==m;g++){var C=b[g],O=C.vlambda,h=C.wlambda;O.set(0,0,0),h.set(0,0,0)}for(y=0;y!==c;y++){u=0;for(var k=0;k!==w;k++){var A=r[k];n=j[k],o=x[k],s=v[k],p=A.computeGWlambda(),d=o*(n-p-A.eps*s),s+d<A.minForce?d=A.minForce-s:s+d>A.maxForce&&(d=A.maxForce-s),v[k]+=d,u+=d>0?d:-d,A.addToWlambda(d)}if(a>u*u)break}for(var g=0;g!==m;g++){var C=b[g],q=C.velocity,z=C.angularVelocity;C.vlambda.vmul(C.linearFactor,C.vlambda),q.vadd(C.vlambda,q),C.wlambda.vmul(C.angularFactor,C.wlambda),z.vadd(C.wlambda,z)}}return y}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,f,n){function o(){this.equations=[]}f.exports=o,o.prototype.solve=function(e,f){return 0},o.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},o.prototype.removeEquation=function(e){var f=this.equations,n=f.indexOf(e);-1!==n&&f.splice(n,1)},o.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,f,n){function o(e){for(u.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}function d(e){for(var f=e.length,n=0;n!==f;n++){var o=e[n];if(!(o.visited||o.body.type&a))return o}return!1}function i(e,f,n,o){for(r.push(e),e.visited=!0,f(e,n,o);r.length;)for(var i,t=r.pop();i=d(t.children);)i.visited=!0,f(i,n,o),r.push(i)}function t(e,f,n){f.push(e.body);for(var o=e.eqs.length,d=0;d!==o;d++){var i=e.eqs[d];-1===n.indexOf(i)&&n.push(i)}}function l(e,f){return f.id-e.id}f.exports=o;var u=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver")),p=e("../objects/Body");o.prototype=new u;var s=[],y=[],c={bodies:[]},a=p.STATIC,r=[];o.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},o.prototype.solve=function(e,f){for(var n=s,o=this.nodePool,u=f.bodies,p=this.equations,a=p.length,r=u.length,w=this.subsolver;o.length<r;)o.push(this.createNode());n.length=r;for(var b=0;r>b;b++)n[b]=o[b];for(var b=0;b!==r;b++){var m=n[b];m.body=u[b],m.children.length=0,m.eqs.length=0,m.visited=!1}for(var N=0;N!==a;N++){var g=p[N],b=u.indexOf(g.bi),x=u.indexOf(g.bj),j=n[b],v=n[x];j.children.push(v),j.eqs.push(g),v.children.push(j),v.eqs.push(g)}var A,C=0,O=y;w.tolerance=this.tolerance,w.iterations=this.iterations;for(var h=c;A=d(n);){O.length=0,h.bodies.length=0,i(A,t,h.bodies,O);var k=O.length;O=O.sort(l);for(var b=0;b!==k;b++)w.addEquation(O[b]);w.solve(e,h);w.removeAllEquations(),C++}return C}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,f,n){var o=function(){};f.exports=o,o.prototype={constructor:o,addEventListener:function(e,f){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(f)&&n[e].push(f),this},hasEventListener:function(e,f){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(f)?!0:!1},removeEventListener:function(e,f){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[e])return this;var o=n[e].indexOf(f);return-1!==o&&n[e].splice(o,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var f=this._listeners,n=f[e.type];if(void 0!==n){e.target=this;for(var o=0,d=n.length;d>o;o++)n[o].call(this,e)}return this}}},{}],50:[function(e,f,n){function o(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new i,this.data=[],this.children=[]}function d(e,f){f=f||{},f.root=null,f.aabb=e,o.call(this,f),this.maxDepth="undefined"!=typeof f.maxDepth?f.maxDepth:8}var i=e("../collision/AABB"),t=e("../math/Vec3");f.exports=d,d.prototype=new o,o.prototype.reset=function(e,f){this.children.length=this.data.length=0},o.prototype.insert=function(e,f,n){var o=this.data;if(n=n||0,!this.aabb.contains(e))return!1;var d=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var i=!1;d.length||(this.subdivide(),i=!0);for(var t=0;8!==t;t++)if(d[t].insert(e,f,n+1))return!0;i&&(d.length=0)}return o.push(f),!0};var l=new t;o.prototype.subdivide=function(){var e=this.aabb,f=e.lowerBound,n=e.upperBound,d=this.children;d.push(new o({aabb:new i({lowerBound:new t(0,0,0)})}),new o({aabb:new i({lowerBound:new t(1,0,0)})}),new o({aabb:new i({lowerBound:new t(1,1,0)})}),new o({aabb:new i({lowerBound:new t(1,1,1)})}),new o({aabb:new i({lowerBound:new t(0,1,1)})}),new o({aabb:new i({lowerBound:new t(0,0,1)})}),new o({aabb:new i({lowerBound:new t(1,0,1)})}),new o({aabb:new i({lowerBound:new t(0,1,0)})})),n.vsub(f,l),l.scale(.5,l);for(var u=this.root||this,p=0;8!==p;p++){var s=d[p];s.root=u;var y=s.aabb.lowerBound;y.x*=l.x,y.y*=l.y,y.z*=l.z,y.vadd(f,y),y.vadd(l,s.aabb.upperBound)}},o.prototype.aabbQuery=function(e,f){for(var n=(this.data,this.children,[this]);n.length;){var o=n.pop();o.aabb.overlaps(e)&&Array.prototype.push.apply(f,o.data),Array.prototype.push.apply(n,o.children)}return f};var u=new i;o.prototype.rayQuery=function(e,f,n){return e.getAABB(u),u.toLocalFrame(f,u),this.aabbQuery(u,n),n},o.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var f=e.pop(),n=f.children.length-1;n>=0;n--)f.children[n].data.length||f.children.splice(n,1);Array.prototype.push.apply(e,f.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,f,n){function o(){this.objects=[],this.type=Object}f.exports=o,o.prototype.release=function(){for(var e=arguments.length,f=0;f!==e;f++)this.objects.push(arguments[f]);return this},o.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},o.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},o.prototype.resize=function(e){for(var f=this.objects;f.length>e;)f.pop();for(;f.length<e;)f.push(this.constructObject());return this}},{}],52:[function(e,f,n){function o(){this.data={keys:[]}}f.exports=o,o.prototype.get=function(e,f){if(e>f){var n=f;f=e,e=n}return this.data[e+"-"+f]},o.prototype.set=function(e,f,n){if(e>f){var o=f;f=e,e=o}var d=e+"-"+f;this.get(e,f)||this.data.keys.push(d),this.data[d]=n},o.prototype.reset=function(){for(var e=this.data,f=e.keys;f.length>0;){var n=f.pop();delete e[n]}}},{}],53:[function(e,f,n){function o(){}f.exports=o,o.defaults=function(e,f){e=e||{};for(var n in f)n in e||(e[n]=f[n]);return e}},{}],54:[function(e,f,n){function o(){i.call(this),this.type=d}f.exports=o;var d=e("../math/Vec3"),i=e("./Pool");o.prototype=new i,o.prototype.constructObject=function(){return new d}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,f,n){function o(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new y,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}function d(e,f,n){for(var o=null,d=e.length,i=0;i!==d;i++){var t=e[i],l=P;e[(i+1)%d].vsub(t,l);var u=Q;l.cross(f,u);var p=R;n.vsub(t,p);var s=u.dot(p);if(!(null===o||s>0&&o===!0||0>=s&&o===!1))return!1;null===o&&(o=s>0)}return!0}f.exports=o;var i=e("../collision/AABB"),t=e("../shapes/Shape"),l=e("../collision/Ray"),u=e("../math/Vec3"),p=e("../math/Transform"),s=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),y=(e("../solver/Solver"),e("../utils/Vec3Pool")),c=e("../equations/ContactEquation"),a=e("../equations/FrictionEquation");o.prototype.createContactEquation=function(e,f,n,o,d,i){var t;this.contactPointPool.length?(t=this.contactPointPool.pop(),t.bi=e,t.bj=f):t=new c(e,f),t.enabled=e.collisionResponse&&f.collisionResponse&&n.collisionResponse&&o.collisionResponse;var l=this.currentContactMaterial;t.restitution=l.restitution,t.setSpookParams(l.contactEquationStiffness,l.contactEquationRelaxation,this.world.dt);var u=n.material||e.material,p=o.material||f.material;return u&&p&&u.restitution>=0&&p.restitution>=0&&(t.restitution=u.restitution*p.restitution),t.si=d||n,t.sj=i||o,t},o.prototype.createFrictionEquationsFromContact=function(e,f){var n=e.bi,o=e.bj,d=e.si,i=e.sj,t=this.world,l=this.currentContactMaterial,u=l.friction,p=d.material||n.material,s=i.material||o.material;if(p&&s&&p.friction>=0&&s.friction>=0&&(u=p.friction*s.friction),u>0){var y=u*t.gravity.length(),c=n.invMass+o.invMass;c>0&&(c=1/c);var r=this.frictionEquationPool,w=r.length?r.pop():new a(n,o,y*c),b=r.length?r.pop():new a(n,o,y*c);return w.bi=b.bi=n,w.bj=b.bj=o,w.minForce=b.minForce=-y*c,w.maxForce=b.maxForce=y*c,w.ri.copy(e.ri),w.rj.copy(e.rj),b.ri.copy(e.ri),b.rj.copy(e.rj),e.ni.tangents(w.t,b.t),w.setSpookParams(l.frictionEquationStiffness,l.frictionEquationRelaxation,t.dt),b.setSpookParams(l.frictionEquationStiffness,l.frictionEquationRelaxation,t.dt),w.enabled=b.enabled=e.enabled,f.push(w,b),!0}return!1};var r=new u,w=new u,b=new u;o.prototype.createFrictionFromAverage=function(e){var f=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(f,this.frictionResult)&&1!==e){var n=this.frictionResult[this.frictionResult.length-2],o=this.frictionResult[this.frictionResult.length-1];r.setZero(),w.setZero(),b.setZero();for(var d=f.bi,i=(f.bj,0);i!==e;i++)f=this.result[this.result.length-1-i],f.bodyA!==d?(r.vadd(f.ni,r),w.vadd(f.ri,w),b.vadd(f.rj,b)):(r.vsub(f.ni,r),w.vadd(f.rj,w),b.vadd(f.ri,b));var t=1/e;w.scale(t,n.ri),b.scale(t,n.rj),o.ri.copy(n.ri),o.rj.copy(n.rj),r.normalize(),r.tangents(n.t,o.t)}};var m=new u,N=new u,g=new s,x=new s;o.prototype.getContacts=function(e,f,n,o,d,i,t){this.contactPointPool=d,this.frictionEquationPool=t,this.result=o,this.frictionResult=i;for(var l=g,u=x,p=m,s=N,y=0,c=e.length;y!==c;y++){var a=e[y],r=f[y],w=null;a.material&&r.material&&(w=n.getContactMaterial(a.material,r.material)||null);for(var b=0;b<a.shapes.length;b++){a.quaternion.mult(a.shapeOrientations[b],l),a.quaternion.vmult(a.shapeOffsets[b],p),p.vadd(a.position,p);for(var j=a.shapes[b],v=0;v<r.shapes.length;v++){r.quaternion.mult(r.shapeOrientations[v],u),r.quaternion.vmult(r.shapeOffsets[v],s),s.vadd(r.position,s);var A=r.shapes[v];if(!(p.distanceTo(s)>j.boundingSphereRadius+A.boundingSphereRadius)){var C=null;j.material&&A.material&&(C=n.getContactMaterial(j.material,A.material)||null),this.currentContactMaterial=C||w||n.defaultContactMaterial;var O=this[j.type|A.type];O&&(j.type<A.type?O.call(this,j,A,p,s,l,u,a,r,j,A):O.call(this,A,j,s,p,u,l,r,a,j,A))}}}}};o.prototype[t.types.BOX|t.types.BOX]=o.prototype.boxBox=function(e,f,n,o,d,i,t,l){e.convexPolyhedronRepresentation.material=e.material,f.convexPolyhedronRepresentation.material=f.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,f.convexPolyhedronRepresentation.collisionResponse=f.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,f.convexPolyhedronRepresentation,n,o,d,i,t,l,e,f)},o.prototype[t.types.BOX|t.types.CONVEXPOLYHEDRON]=o.prototype.boxConvex=function(e,f,n,o,d,i,t,l){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,f,n,o,d,i,t,l,e,f)},o.prototype[t.types.BOX|t.types.PARTICLE]=o.prototype.boxParticle=function(e,f,n,o,d,i,t,l){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,f,n,o,d,i,t,l,e,f)},o.prototype[t.types.SPHERE]=o.prototype.sphereSphere=function(e,f,n,o,d,i,t,l,u,p){var s=this.createContactEquation(t,l,e,f,u,p);o.vsub(n,s.ni),s.ni.normalize(),s.ri.copy(s.ni),s.rj.copy(s.ni),s.ri.mult(e.radius,s.ri),s.rj.mult(-f.radius,s.rj),s.ri.vadd(n,s.ri),s.ri.vsub(t.position,s.ri),s.rj.vadd(o,s.rj),s.rj.vsub(l.position,s.rj),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult)};var j=new u,v=new u,A=new u;o.prototype[t.types.PLANE|t.types.TRIMESH]=o.prototype.planeTrimesh=function(e,f,n,o,d,i,t,l,s,y){var c=new u,a=j;a.set(0,0,1),d.vmult(a,a);for(var r=0;r<f.vertices.length/3;r++){f.getVertex(r,c);var w=new u;w.copy(c),p.pointToWorldFrame(o,i,w,c);var b=v;c.vsub(n,b);var m=a.dot(b);if(0>=m){var N=this.createContactEquation(t,l,e,f,s,y);N.ni.copy(a);var g=A;a.scale(b.dot(a),g),c.vsub(g,g),N.ri.copy(g),N.ri.vsub(t.position,N.ri),N.rj.copy(c),N.rj.vsub(l.position,N.rj),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult)}}};var C=new u,O=new u,h=(new u,new u),k=new u,q=new u,z=new u,B=new u,D=new u,E=new u,F=new u,G=new u,H=new u,I=new u,J=new i,K=[];o.prototype[t.types.SPHERE|t.types.TRIMESH]=o.prototype.sphereTrimesh=function(e,f,n,o,d,i,t,u,s,y){var c=q,a=z,r=B,w=D,b=E,m=F,N=J,g=k,x=O,j=K;p.pointToLocalFrame(o,i,n,b);var v=e.radius;N.lowerBound.set(b.x-v,b.y-v,b.z-v),N.upperBound.set(b.x+v,b.y+v,b.z+v),f.getTrianglesInAABB(N,j);for(var A=h,L=e.radius*e.radius,M=0;M<j.length;M++)for(var P=0;3>P;P++)if(f.getVertex(f.indices[3*j[M]+P],A),A.vsub(b,x),x.norm2()<=L){g.copy(A),p.pointToWorldFrame(o,i,g,A),A.vsub(n,x);var Q=this.createContactEquation(t,u,e,f,s,y);Q.ni.copy(x),Q.ni.normalize(),Q.ri.copy(Q.ni),Q.ri.scale(e.radius,Q.ri),Q.ri.vadd(n,Q.ri),Q.ri.vsub(t.position,Q.ri),Q.rj.copy(A),Q.rj.vsub(u.position,Q.rj),this.result.push(Q),this.createFrictionEquationsFromContact(Q,this.frictionResult)}for(var M=0;M<j.length;M++)for(var P=0;3>P;P++){f.getVertex(f.indices[3*j[M]+P],c),f.getVertex(f.indices[3*j[M]+(P+1)%3],a),a.vsub(c,r),b.vsub(a,m);var R=m.dot(r);b.vsub(c,m);var S=m.dot(r);if(S>0&&0>R){b.vsub(c,m),w.copy(r),w.normalize(),S=m.dot(w),w.scale(S,m),m.vadd(c,m);var T=m.distanceTo(b);if(T<e.radius){var Q=this.createContactEquation(t,u,e,f,s,y);m.vsub(b,Q.ni),Q.ni.normalize(),Q.ni.scale(e.radius,Q.ri),p.pointToWorldFrame(o,i,m,m),m.vsub(u.position,Q.rj),p.vectorToWorldFrame(i,Q.ni,Q.ni),p.vectorToWorldFrame(i,Q.ri,Q.ri),this.result.push(Q),this.createFrictionEquationsFromContact(Q,this.frictionResult)}}}for(var U=G,V=H,W=I,X=C,M=0,Y=j.length;M!==Y;M++){f.getTriangleVertices(j[M],U,V,W),f.getNormal(j[M],X),b.vsub(U,m);var T=m.dot(X);if(X.scale(T,m),b.vsub(m,m),T=m.distanceTo(b),l.pointInTriangle(m,U,V,W)&&T<e.radius){var Q=this.createContactEquation(t,u,e,f,s,y);m.vsub(b,Q.ni),Q.ni.normalize(),Q.ni.scale(e.radius,Q.ri),p.pointToWorldFrame(o,i,m,m),m.vsub(u.position,Q.rj),p.vectorToWorldFrame(i,Q.ni,Q.ni),p.vectorToWorldFrame(i,Q.ri,Q.ri),this.result.push(Q),this.createFrictionEquationsFromContact(Q,this.frictionResult)}}j.length=0};var L=new u,M=new u;o.prototype[t.types.SPHERE|t.types.PLANE]=o.prototype.spherePlane=function(e,f,n,o,d,i,t,l,u,p){var s=this.createContactEquation(t,l,e,f,u,p);if(s.ni.set(0,0,1),i.vmult(s.ni,s.ni),s.ni.negate(s.ni),s.ni.normalize(),s.ni.mult(e.radius,s.ri),n.vsub(o,L),s.ni.mult(s.ni.dot(L),M),L.vsub(M,s.rj),-L.dot(s.ni)<=e.radius){var y=s.ri,c=s.rj;y.vadd(n,y),y.vsub(t.position,y),c.vadd(o,c),c.vsub(l.position,c),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult)}};var P=new u,Q=new u,R=new u,S=new u,T=new u,U=new u,V=new u,W=[new u,new u,new u,new u,new u,new u],X=new u,Y=new u,Z=new u,$=new u;o.prototype[t.types.SPHERE|t.types.BOX]=o.prototype.sphereBox=function(e,f,n,o,d,i,t,l,u,p){var s=this.v3pool,y=W;n.vsub(o,S),f.getSideNormals(y,i);for(var c=e.radius,a=!1,r=Y,w=Z,b=$,m=null,N=0,g=0,x=0,j=null,v=0,A=y.length;v!==A&&a===!1;v++){var C=T;C.copy(y[v]);var O=C.norm();C.normalize();var h=S.dot(C);if(O+c>h&&h>0){var k=U,q=V;k.copy(y[(v+1)%3]),q.copy(y[(v+2)%3]);var z=k.norm(),B=q.norm();k.normalize(),q.normalize();var D=S.dot(k),E=S.dot(q);if(z>D&&D>-z&&B>E&&E>-B){var F=Math.abs(h-O-c);(null===j||j>F)&&(j=F,g=D,x=E,m=O,r.copy(C),w.copy(k),b.copy(q),N++)}}}if(N){a=!0;var G=this.createContactEquation(t,l,e,f,u,p);r.mult(-c,G.ri),G.ni.copy(r),G.ni.negate(G.ni),r.mult(m,r),w.mult(g,w),r.vadd(w,r),b.mult(x,b),r.vadd(b,G.rj),G.ri.vadd(n,G.ri),G.ri.vsub(t.position,G.ri),G.rj.vadd(o,G.rj),G.rj.vsub(l.position,G.rj),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}for(var H=s.get(),I=X,J=0;2!==J&&!a;J++)for(var K=0;2!==K&&!a;K++)for(var L=0;2!==L&&!a;L++)if(H.set(0,0,0),J?H.vadd(y[0],H):H.vsub(y[0],H),K?H.vadd(y[1],H):H.vsub(y[1],H),L?H.vadd(y[2],H):H.vsub(y[2],H),o.vadd(H,I),I.vsub(n,I),I.norm2()<c*c){a=!0;var G=this.createContactEquation(t,l,e,f,u,p);G.ri.copy(I),G.ri.normalize(),G.ni.copy(G.ri),G.ri.mult(c,G.ri),G.rj.copy(H),G.ri.vadd(n,G.ri),G.ri.vsub(t.position,G.ri),G.rj.vadd(o,G.rj),G.rj.vsub(l.position,G.rj),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}s.release(H),H=null;for(var M=s.get(),P=s.get(),G=s.get(),Q=s.get(),F=s.get(),R=y.length,J=0;J!==R&&!a;J++)for(var K=0;K!==R&&!a;K++)if(J%3!==K%3){y[K].cross(y[J],M),M.normalize(),y[J].vadd(y[K],P),G.copy(n),G.vsub(P,G),G.vsub(o,G);var _=G.dot(M);M.mult(_,Q);for(var L=0;L===J%3||L===K%3;)L++;F.copy(n),F.vsub(Q,F),F.vsub(P,F),F.vsub(o,F);var ee=Math.abs(_),fe=F.norm();if(ee<y[L].norm()&&c>fe){a=!0;var ne=this.createContactEquation(t,l,e,f,u,p);P.vadd(Q,ne.rj),ne.rj.copy(ne.rj),F.negate(ne.ni),ne.ni.normalize(),ne.ri.copy(ne.rj),ne.ri.vadd(o,ne.ri),ne.ri.vsub(n,ne.ri),ne.ri.normalize(),ne.ri.mult(c,ne.ri),ne.ri.vadd(n,ne.ri),ne.ri.vsub(t.position,ne.ri),ne.rj.vadd(o,ne.rj),ne.rj.vsub(l.position,ne.rj),this.result.push(ne),this.createFrictionEquationsFromContact(ne,this.frictionResult)}}s.release(M,P,G,Q,F)};var _=new u,ee=new u,fe=new u,ne=new u,oe=new u,de=new u,ie=new u,te=new u,le=new u,ue=new u;o.prototype[t.types.SPHERE|t.types.CONVEXPOLYHEDRON]=o.prototype.sphereConvex=function(e,f,n,o,i,t,l,u,p,s){var y=this.v3pool;n.vsub(o,_);for(var c=f.faceNormals,a=f.faces,r=f.vertices,w=e.radius,b=0;b!==r.length;b++){var m=r[b],N=oe;t.vmult(m,N),o.vadd(N,N);var g=ne;if(N.vsub(n,g),g.norm2()<w*w){j=!0;var x=this.createContactEquation(l,u,e,f,p,s);return x.ri.copy(g),x.ri.normalize(),x.ni.copy(x.ri),x.ri.mult(w,x.ri),N.vsub(o,x.rj),x.ri.vadd(n,x.ri),x.ri.vsub(l.position,x.ri),x.rj.vadd(o,x.rj),x.rj.vsub(u.position,x.rj),this.result.push(x),void this.createFrictionEquationsFromContact(x,this.frictionResult)}}for(var j=!1,b=0,v=a.length;b!==v&&j===!1;b++){var A=c[b],C=a[b],O=de;t.vmult(A,O);var h=ie;t.vmult(r[C[0]],h),h.vadd(o,h);var k=te;O.mult(-w,k),n.vadd(k,k);var q=le;k.vsub(h,q);var z=q.dot(O),B=ue;if(n.vsub(h,B),0>z&&B.dot(O)>0){for(var D=[],E=0,F=C.length;E!==F;E++){var G=y.get();t.vmult(r[C[E]],G),o.vadd(G,G),D.push(G)}if(d(D,O,n)){j=!0;var x=this.createContactEquation(l,u,e,f,p,s);O.mult(-w,x.ri),O.negate(x.ni);var H=y.get();O.mult(-z,H);var I=y.get();O.mult(-w,I),n.vsub(o,x.rj),x.rj.vadd(I,x.rj),x.rj.vadd(H,x.rj),x.rj.vadd(o,x.rj),x.rj.vsub(u.position,x.rj),x.ri.vadd(n,x.ri),x.ri.vsub(l.position,x.ri),y.release(H),y.release(I),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult);for(var E=0,J=D.length;E!==J;E++)y.release(D[E]);return}for(var E=0;E!==C.length;E++){var K=y.get(),L=y.get();t.vmult(r[C[(E+1)%C.length]],K),t.vmult(r[C[(E+2)%C.length]],L),o.vadd(K,K),o.vadd(L,L);var M=ee;L.vsub(K,M);var P=fe;M.unit(P);var Q=y.get(),R=y.get();n.vsub(K,R);var S=R.dot(P);P.mult(S,Q),Q.vadd(K,Q);var T=y.get();if(Q.vsub(n,T),S>0&&S*S<M.norm2()&&T.norm2()<w*w){var x=this.createContactEquation(l,u,e,f,p,s);Q.vsub(o,x.rj),Q.vsub(n,x.ni),x.ni.normalize(),x.ni.mult(w,x.ri),x.rj.vadd(o,x.rj),x.rj.vsub(u.position,x.rj),x.ri.vadd(n,x.ri),x.ri.vsub(l.position,x.ri),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult);for(var E=0,J=D.length;E!==J;E++)y.release(D[E]);return y.release(K),y.release(L),y.release(Q),y.release(T),void y.release(R)}y.release(K),y.release(L),y.release(Q),y.release(T),y.release(R)}for(var E=0,J=D.length;E!==J;E++)y.release(D[E])}}};new u,new u;o.prototype[t.types.PLANE|t.types.BOX]=o.prototype.planeBox=function(e,f,n,o,d,i,t,l){f.convexPolyhedronRepresentation.material=f.material,f.convexPolyhedronRepresentation.collisionResponse=f.collisionResponse,f.convexPolyhedronRepresentation.id=f.id,this.planeConvex(e,f.convexPolyhedronRepresentation,n,o,d,i,t,l,e,f)};var pe=new u,se=new u,ye=new u,ce=new u;o.prototype[t.types.PLANE|t.types.CONVEXPOLYHEDRON]=o.prototype.planeConvex=function(e,f,n,o,d,i,t,l,u,p){var s=pe,y=se;y.set(0,0,1),d.vmult(y,y);for(var c=0,a=ye,r=0;r!==f.vertices.length;r++){s.copy(f.vertices[r]),i.vmult(s,s),o.vadd(s,s),s.vsub(n,a);var w=y.dot(a);if(0>=w){var b=this.createContactEquation(t,l,e,f,u,p),m=ce;y.mult(y.dot(a),m),s.vsub(m,m),m.vsub(n,b.ri),b.ni.copy(y),s.vsub(o,b.rj),b.ri.vadd(n,b.ri),b.ri.vsub(t.position,b.ri),b.rj.vadd(o,b.rj),b.rj.vsub(l.position,b.rj),this.result.push(b),c++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(b,this.frictionResult)}}this.enableFrictionReduction&&c&&this.createFrictionFromAverage(c)};var ae=new u,re=new u;o.prototype[t.types.CONVEXPOLYHEDRON]=o.prototype.convexConvex=function(e,f,n,o,d,i,t,l,u,p,s,y){var c=ae;if(!(n.distanceTo(o)>e.boundingSphereRadius+f.boundingSphereRadius)&&e.findSeparatingAxis(f,n,d,o,i,c,s,y)){var a=[],r=re;e.clipAgainstHull(n,d,f,o,i,c,-100,100,a);for(var w=0,b=0;b!==a.length;b++){var m=this.createContactEquation(t,l,e,f,u,p),N=m.ri,g=m.rj;c.negate(m.ni),a[b].normal.negate(r),r.mult(a[b].depth,r),a[b].point.vadd(r,N),g.copy(a[b].point),N.vsub(n,N),g.vsub(o,g),N.vadd(n,N),N.vsub(t.position,N),g.vadd(o,g),g.vsub(l.position,g),this.result.push(m),w++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&w&&this.createFrictionFromAverage(w)}};var we=new u,be=new u,me=new u;o.prototype[t.types.PLANE|t.types.PARTICLE]=o.prototype.planeParticle=function(e,f,n,o,d,i,t,l,u,p){var s=we;s.set(0,0,1),t.quaternion.vmult(s,s);var y=be;o.vsub(t.position,y);var c=s.dot(y);if(0>=c){var a=this.createContactEquation(l,t,f,e,u,p);a.ni.copy(s),a.ni.negate(a.ni),a.ri.set(0,0,0);var r=me;s.mult(s.dot(o),r),o.vsub(r,r),a.rj.copy(r),this.result.push(a),this.createFrictionEquationsFromContact(a,this.frictionResult)}};var Ne=new u;o.prototype[t.types.PARTICLE|t.types.SPHERE]=o.prototype.sphereParticle=function(e,f,n,o,d,i,t,l,u,p){var s=Ne;s.set(0,0,1),o.vsub(n,s);var y=s.norm2();if(y<=e.radius*e.radius){var c=this.createContactEquation(l,t,f,e,u,p);s.normalize(),c.rj.copy(s),c.rj.mult(e.radius,c.rj),c.ni.copy(s),c.ni.negate(c.ni),c.ri.set(0,0,0),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var ge=new s,xe=new u,je=(new u,new u),ve=new u,Ae=new u;o.prototype[t.types.PARTICLE|t.types.CONVEXPOLYHEDRON]=o.prototype.convexParticle=function(e,f,n,o,d,i,t,l,u,p){var s=-1,y=je,c=Ae,a=null,r=0,w=xe;if(w.copy(o),w.vsub(n,w),d.conjugate(ge),ge.vmult(w,w),e.pointIsInside(w)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(n,d),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(d);for(var b=0,m=e.faces.length;b!==m;b++){var N=[e.worldVertices[e.faces[b][0]]],g=e.worldFaceNormals[b];o.vsub(N[0],ve);var x=-g.dot(ve);(null===a||Math.abs(x)<Math.abs(a))&&(a=x,s=b,y.copy(g),r++)}if(-1!==s){var j=this.createContactEquation(l,t,f,e,u,p);y.mult(a,c),c.vadd(o,c),c.vsub(n,c),j.rj.copy(c),y.negate(j.ni),j.ri.set(0,0,0);var v=j.ri,A=j.rj;v.vadd(o,v),v.vsub(l.position,v),A.vadd(n,A),A.vsub(t.position,A),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},o.prototype[t.types.BOX|t.types.HEIGHTFIELD]=o.prototype.boxHeightfield=function(e,f,n,o,d,i,t,l){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,f,n,o,d,i,t,l,e,f)};var Ce=new u,Oe=new u,he=[0];o.prototype[t.types.CONVEXPOLYHEDRON|t.types.HEIGHTFIELD]=o.prototype.convexHeightfield=function(e,f,n,o,d,i,t,l){var u=f.data,s=f.elementSize,y=e.boundingSphereRadius,c=Oe,a=he,r=Ce;p.pointToLocalFrame(o,i,n,r);var w=Math.floor((r.x-y)/s)-1,b=Math.ceil((r.x+y)/s)+1,m=Math.floor((r.y-y)/s)-1,N=Math.ceil((r.y+y)/s)+1;if(!(0>b||0>N||w>u.length||m>u[0].length)){0>w&&(w=0),0>b&&(b=0),0>m&&(m=0),0>N&&(N=0),w>=u.length&&(w=u.length-1),b>=u.length&&(b=u.length-1),N>=u[0].length&&(N=u[0].length-1),m>=u[0].length&&(m=u[0].length-1);var g=[];f.getRectMinMax(w,m,b,N,g);var x=g[0],j=g[1];if(!(r.z-y>j||r.z+y<x))for(var v=w;b>v;v++)for(var A=m;N>A;A++)f.getConvexTrianglePillar(v,A,!1),p.pointToWorldFrame(o,i,f.pillarOffset,c),n.distanceTo(c)<f.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,f.pillarConvex,n,c,d,i,t,l,null,null,a,null),f.getConvexTrianglePillar(v,A,!0),p.pointToWorldFrame(o,i,f.pillarOffset,c),n.distanceTo(c)<f.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,f.pillarConvex,n,c,d,i,t,l,null,null,a,null)}};var ke=new u,qe=new u;o.prototype[t.types.SPHERE|t.types.HEIGHTFIELD]=o.prototype.sphereHeightfield=function(e,f,n,o,d,i,t,l){var u=f.data,s=e.radius,y=f.elementSize,c=qe,a=ke;p.pointToLocalFrame(o,i,n,a);var r=Math.floor((a.x-s)/y)-1,w=Math.ceil((a.x+s)/y)+1,b=Math.floor((a.y-s)/y)-1,m=Math.ceil((a.y+s)/y)+1;if(!(0>w||0>m||r>u.length||m>u[0].length)){0>r&&(r=0),0>w&&(w=0),0>b&&(b=0),0>m&&(m=0),r>=u.length&&(r=u.length-1),w>=u.length&&(w=u.length-1),m>=u[0].length&&(m=u[0].length-1),b>=u[0].length&&(b=u[0].length-1);var N=[];f.getRectMinMax(r,b,w,m,N);var g=N[0],x=N[1];if(!(a.z-s>x||a.z+s<g))for(var j=this.result,v=r;w>v;v++)for(var A=b;m>A;A++){var C=j.length;f.getConvexTrianglePillar(v,A,!1),p.pointToWorldFrame(o,i,f.pillarOffset,c),n.distanceTo(c)<f.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,f.pillarConvex,n,c,d,i,t,l),f.getConvexTrianglePillar(v,A,!0),p.pointToWorldFrame(o,i,f.pillarOffset,c),n.distanceTo(c)<f.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,f.pillarConvex,n,c,d,i,t,l);var O=j.length-C;if(O>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,f,n){function o(e){e=e||{},u.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast?e.quatNormalizeFast:!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new d,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new m,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new t,this.constraints=[],this.narrowphase=new l(this),this.collisionMatrix=new p,this.collisionMatrixPrevious=new p,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new a,this.defaultMaterial=new s("default"),this.defaultContactMaterial=new y(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.broadphase.setWorld(this)}f.exports=o;var d=(e("../shapes/Shape"),e("../math/Vec3")),i=e("../math/Quaternion"),t=e("../solver/GSSolver"),l=(e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),u=e("../utils/EventTarget"),p=e("../collision/ArrayCollisionMatrix"),s=e("../material/Material"),y=e("../material/ContactMaterial"),c=e("../objects/Body"),a=e("../utils/TupleDictionary"),r=e("../collision/RaycastResult"),w=e("../collision/AABB"),b=e("../collision/Ray"),m=e("../collision/NaiveBroadphase");o.prototype=new u;var N=(new w,new b);if(o.prototype.getContactMaterial=function(e,f){return this.contactMaterialTable.get(e.id,f.id)},o.prototype.numObjects=function(){return this.bodies.length},o.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},o.prototype.add=o.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof c&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent))},o.prototype.addConstraint=function(e){this.constraints.push(e)},o.prototype.removeConstraint=function(e){var f=this.constraints.indexOf(e);-1!==f&&this.constraints.splice(f,1)},o.prototype.rayTest=function(e,f,n){n instanceof r?this.raycastClosest(e,f,{skipBackfaces:!0},n):this.raycastAll(e,f,{skipBackfaces:!0},n)},o.prototype.raycastAll=function(e,f,n,o){return n.mode=b.ALL,n.from=e,n.to=f,n.callback=o,N.intersectWorld(this,n)},o.prototype.raycastAny=function(e,f,n,o){return n.mode=b.ANY,n.from=e,n.to=f,n.result=o,N.intersectWorld(this,n)},o.prototype.raycastClosest=function(e,f,n,o){return n.mode=b.CLOSEST,n.from=e,n.to=f,n.result=o,N.intersectWorld(this,n)},o.prototype.remove=function(e){e.world=null;var f=this.bodies.length-1,n=this.bodies,o=n.indexOf(e);if(-1!==o){n.splice(o,1);for(var d=0;d!==n.length;d++)n[d].index=d;
this.collisionMatrix.setNumObjects(f),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)}},o.prototype.removeBody=o.prototype.remove,o.prototype.addMaterial=function(e){this.materials.push(e)},o.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var g=Date.now();performance.timing&&performance.timing.navigationStart&&(g=performance.timing.navigationStart),performance.now=function(){return Date.now()-g}}new d;o.prototype.step=function(e,f,n){if(n=n||10,f=f||0,0===f)this.internalStep(e),this.time+=e;else{this.accumulator+=f;for(var o=0;this.accumulator>=e&&n>o;)this.internalStep(e),this.accumulator-=e,o++;for(var d=this.accumulator%e/e,i=0;i!==this.bodies.length;i++){var t=this.bodies[i];t.previousPosition.lerp(t.position,d,t.interpolatedPosition),t.previousQuaternion.slerp(t.quaternion,d,t.interpolatedQuaternion),t.previousQuaternion.normalize()}this.time+=f}};var x={type:"postStep"},j={type:"preStep"},v={type:c.COLLIDE_EVENT_NAME,body:null,contact:null},A=[],C=[],O=[],h=[];new d,new d,new d,new d,new d,new d,new d,new d,new d,new i,new i,new i,new d;o.prototype.internalStep=function(e){this.dt=e;var f,n=this.contacts,o=O,d=h,i=this.numObjects(),t=this.bodies,l=this.solver,u=this.gravity,p=this.doProfiling,s=this.profile,y=c.DYNAMIC,a=this.constraints,r=C,w=(u.norm(),u.x),b=u.y,m=u.z,N=0;for(p&&(f=performance.now()),N=0;N!==i;N++){var g=t[N];if(g.type===y){var k=g.force,q=g.mass;k.x+=q*w,k.y+=q*b,k.z+=q*m}}for(var N=0,z=this.subsystems.length;N!==z;N++)this.subsystems[N].update();p&&(f=performance.now()),o.length=0,d.length=0,this.broadphase.collisionPairs(this,o,d),p&&(s.broadphase=performance.now()-f);var B=a.length;for(N=0;N!==B;N++){var D=a[N];if(!D.collideConnected)for(var E=o.length-1;E>=0;E-=1)(D.bodyA===o[E]&&D.bodyB===d[E]||D.bodyB===o[E]&&D.bodyA===d[E])&&(o.splice(E,1),d.splice(E,1))}this.collisionMatrixTick(),p&&(f=performance.now());var F=A,G=n.length;for(N=0;N!==G;N++)F.push(n[N]);n.length=0;var H=this.frictionEquations.length;for(N=0;N!==H;N++)r.push(this.frictionEquations[N]);this.frictionEquations.length=0,this.narrowphase.getContacts(o,d,this,n,F,this.frictionEquations,r),p&&(s.narrowphase=performance.now()-f),p&&(f=performance.now());for(var N=0;N<this.frictionEquations.length;N++)l.addEquation(this.frictionEquations[N]);for(var I=n.length,J=0;J!==I;J++){var K,D=n[J],g=D.bi,L=D.bj;D.si,D.sj;K=g.material&&L.material?this.getContactMaterial(g.material,L.material)||this.defaultContactMaterial:this.defaultContactMaterial;var M=K.friction;if(g.material&&L.material&&(g.material.friction>=0&&L.material.friction>=0&&(M=g.material.friction*L.material.friction),g.material.restitution>=0&&L.material.restitution>=0&&(D.restitution=g.material.restitution*L.material.restitution)),l.addEquation(D),g.allowSleep&&g.type===c.DYNAMIC&&g.sleepState===c.SLEEPING&&L.sleepState===c.AWAKE&&L.type!==c.STATIC){var P=L.velocity.norm2()+L.angularVelocity.norm2(),Q=Math.pow(L.sleepSpeedLimit,2);P>=2*Q&&(g._wakeUpAfterNarrowphase=!0)}if(L.allowSleep&&L.type===c.DYNAMIC&&L.sleepState===c.SLEEPING&&g.sleepState===c.AWAKE&&g.type!==c.STATIC){var R=g.velocity.norm2()+g.angularVelocity.norm2(),S=Math.pow(g.sleepSpeedLimit,2);R>=2*S&&(L._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(g,L,!0),this.collisionMatrixPrevious.get(g,L)||(v.body=L,v.contact=D,g.dispatchEvent(v),v.body=g,L.dispatchEvent(v))}for(p&&(s.makeContactConstraints=performance.now()-f,f=performance.now()),N=0;N!==i;N++){var g=t[N];g._wakeUpAfterNarrowphase&&(g.wakeUp(),g._wakeUpAfterNarrowphase=!1)}var B=a.length;for(N=0;N!==B;N++){var D=a[N];D.update();for(var E=0,T=D.equations.length;E!==T;E++){var U=D.equations[E];l.addEquation(U)}}l.solve(e,this),p&&(s.solve=performance.now()-f),l.removeAllEquations();var V=Math.pow;for(N=0;N!==i;N++){var g=t[N];if(g.type&y){var W=V(1-g.linearDamping,e),X=g.velocity;X.mult(W,X);var Y=g.angularVelocity;if(Y){var Z=V(1-g.angularDamping,e);Y.mult(Z,Y)}}}for(this.dispatchEvent(j),N=0;N!==i;N++){var g=t[N];g.preStep&&g.preStep.call(g)}p&&(f=performance.now());var $=this.stepnumber,_=$%(this.quatNormalizeSkip+1)===0,ee=this.quatNormalizeFast;for(N=0;N!==i;N++)t[N].integrate(e,_,ee);for(this.clearForces(),this.broadphase.dirty=!0,p&&(s.integrate=performance.now()-f),this.time+=e,this.stepnumber+=1,this.dispatchEvent(x),N=0;N!==i;N++){var g=t[N],fe=g.postStep;fe&&fe.call(g)}if(this.allowSleep)for(N=0;N!==i;N++)t[N].sleepTick(this.time)},o.prototype.clearForces=function(){for(var e=this.bodies,f=e.length,n=0;n!==f;n++){var o=e[n];o.force,o.torque;o.force.set(0,0,0),o.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"./Narrowphase":55}]},{},[2])(2)});